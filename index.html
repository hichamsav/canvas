<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8" />
    <title>EXTRACTION CANVAS â€” Ù…Ø­Ø³Ù‘Ù†</title>
    <style>
        body {
            direction: rtl;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 10px;
            display: flex;
            gap: 10px;
            height: 100vh;
            font-size: 13px;
            overflow: hidden;
            box-sizing: border-box;
        }
        .container {
            flex: 1;
            max-width: 50%;
            display: flex;
            flex-direction: column;
            border: 1px solid #ccc;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 1px 1px 5px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        h1, h3 { font-size: 16px; margin-top: 0; text-align:center; }
        input[type="file"], input[type="text"], textarea {
            width: 100%;
            font-size: 12px;
            padding: 8px;
            margin-bottom: 8px;
            box-sizing: border-box;
            font-family: monospace;
            height: 60px;
            resize: none;
        }
        button {
            padding: 6px 10px;
            font-size: 13px;
            cursor: pointer;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            margin-bottom: 8px;
            transition: background-color 0.3s ease;
        }
        button:hover { background-color: #0056b3; }
        .copy-button { background-color: #28a745; }
        .copy-button:hover { background-color: #1e7e34; }
        .row { display:flex; gap:6px; margin-bottom:10px; }
        .field-container { flex:1; display:flex; flex-direction:column; }
        .line-count { font-weight:bold; font-size:12px; color:#007bff; text-align:center; margin-bottom:4px; }
        label { font-weight:bold; font-size:12px; margin-bottom:4px; }
        #progressContainer { width:100%; height:8px; background:#e0e0e0; position:fixed; bottom:0; right:0; left:0; display:none; z-index:9999; }
        #progressBar { height:100%; width:0%; background:#007bff; transition:width .1s ease; }
    </style>

    <!-- SheetJS (unchanged) -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
</head>
<body>
    <div class="container" style="max-width:45%;">
        <h1>ğŸ“ EXTRACTION CANVAS â€” Ù…Ø­Ø³Ù‘Ù† (Web Worker + ØªØ¯ÙÙ‚)</h1>

        <!-- Ø§Ø®ØªÙŠØ§Ø± Ù…Ø¬Ù„Ø¯ -->
        <input type="file" id="folderInput" webkitdirectory directory multiple accept=".txt,.html" />
        <div class="row">
            <button id="mergeBtn">ğŸ” Ø¯Ù…Ø¬ ÙˆÙ…Ø¹Ø§Ù„Ø¬Ø© (Ø§Ù„Ø®Ù„ÙÙŠØ©)</button>
            <button id="cancelBtn" style="background:#6c757d;">Ø¥ÙŠÙ‚Ø§Ù</button>
        </div>

        <h3>ğŸ” Ø§Ø³ØªØ®Ø±Ø§Ø¬ ÙƒÙ„Ù…Ø§Øª Ù…ØªØ¹Ø¯Ø¯Ø© (Ù…ÙØµÙˆÙ„Ø© Ø¨ÙØ§ØµÙ„Ø©)</h3>
        <input type="text" id="singleKeywordInput" value="Envoy,Sent,ID CASE,Client :,TÃ©lÃ©phone,AccÃ¨s rÃ©seau,ActivitÃ©s de service,Adresse Installation" />
        <label><input type="checkbox" id="startOnlySingleCheckbox" checked /> Ø§Ø³ØªØ®Ø±Ø§Ø¬ ÙÙ‚Ø· Ø§Ù„Ø£Ø³Ø·Ø± Ø§Ù„ØªÙŠ <strong>ØªØ¨Ø¯Ø£</strong> Ø¨Ø§Ù„ÙƒÙ„Ù…Ø§Øª</label><br />
        <button id="extractBtn">ğŸ” Ø§Ø³ØªØ®Ø±Ø§Ø¬</button>
        <button id="copySingleBtn" class="copy-button">ğŸ“‹ Ù†Ø³Ø® Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬</button>

        <textarea id="singleKeywordOutput" rows="6" readonly placeholder="Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ Ø§Ù„Ø£Ø³Ø·Ø± Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬Ø© (Ø®Ù„ÙÙŠØ§Ù‹)"></textarea>

        <p style="font-size:12px;color:#666;">Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ø³ØªØ®Ø¯Ø§Ù… Web Worker Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø© ÙŠÙ‚Ù„Ù„ ØªØ¬Ù…ÙŠØ¯ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙŠØ­Ø³Ù† Ø§Ù„Ø£Ø¯Ø§Ø¡ ÙˆØ§Ù„Ø°Ø§ÙƒØ±Ø©.</p>
    </div>

    <div class="container" style="max-width:50%;">
        <div class="row">
            <div class="field-container">
                <div class="line-count" id="count0">0 Ø³Ø·Ø±</div>
                <textarea id="field0" readonly></textarea>
                <button class="copy-button" onclick="copyField(0)">ğŸ“‹ Ù†Ø³Ø® EnvoyÃ©</button>
            </div>
            <div class="field-container">
                <div class="line-count" id="count1">0 Ø³Ø·Ø±</div>
                <textarea id="field1" readonly></textarea>
                <button class="copy-button" onclick="copyField(1)">ğŸ“‹ Ù†Ø³Ø® ID CASE</button>
            </div>
            <div class="field-container">
                <div class="line-count" id="count2">0 Ø³Ø·Ø±</div>
                <textarea id="field2" readonly></textarea>
                <button class="copy-button" onclick="copyField(2)">ğŸ“‹ Ù†Ø³Ø® Client</button>
            </div>
        </div>

        <div class="row">
            <div class="field-container">
                <div class="line-count" id="count3">0 Ø³Ø·Ø±</div>
                <textarea id="field3" readonly></textarea>
                <button class="copy-button" onclick="copyField(3)">ğŸ“‹ Ù†Ø³Ø® TÃ©lÃ©phone</button>
            </div>
            <div class="field-container">
                <div class="line-count" id="count4">0 Ø³Ø·Ø±</div>
                <textarea id="field4" readonly></textarea>
                <button class="copy-button" onclick="copyField(4)">ğŸ“‹ Ù†Ø³Ø® AccÃ¨s rÃ©seau</button>
            </div>
            <div class="field-container">
                <div class="line-count" id="count5">0 Ø³Ø·Ø±</div>
                <textarea id="field5" readonly></textarea>
                <button class="copy-button" onclick="copyField(5)">ğŸ“‹ Ù†Ø³Ø® ActivitÃ©s de service</button>
            </div>
        </div>

        <div class="row">
            <div class="field-container">
                <div class="line-count" id="count6">0 Ø³Ø·Ø±</div>
                <textarea id="field6" readonly></textarea>
                <button class="copy-button" onclick="copyField(6)">ğŸ“‹ Ù†Ø³Ø® Adresse Installation</button>
            </div>
        </div>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-top:20px;">
            <button id="dedupBtn" style="background:#dc3545;">ğŸ§¹ Ù…Ø³Ø­ Ø§Ù„ØªÙƒØ±Ø§Ø± + Ù†Ø³Ø® Ø¨Ø¹Ø¯ 2 Ø«</button>
            <button id="exportBtn" style="background:#ff6600;">â¬‡ï¸ ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ Excel</button>
        </div>
    </div>

    <div id="progressContainer">
        <div id="progressBar"></div>
    </div>

<script>
/*
  Ø§Ù„ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©:
  - Ø§Ø³ØªØ®Ø¯Ø§Ù… Web Worker Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¯Ù…Ø¬ ÙˆØ§Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ù† Ø¯ÙˆÙ† ØªØ¬Ù…ÙŠØ¯ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….
  - Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„ÙØ§Øª Ø¨Ø§Ù„ØªØªØ§Ø¨Ø¹ (stream) Ø¥Ù† Ø£Ù…ÙƒÙ† Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø©.
  - Ø¥Ø±Ø³Ø§Ù„ Ø£Ø¬Ø²Ø§Ø¡ (chunks) Ø¥Ù„Ù‰ Ø§Ù„Worker Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© ØªØ¯Ø±ÙŠØ¬ÙŠØ©.
  - Ø¥Ø±Ø³Ø§Ù„ ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„ØªÙ‚Ø¯Ù… Ù…Ù† Ø§Ù„Worker Ù„Ù„ÙˆØ§Ø¬Ù‡Ø© Ù„Ø¹Ø±Ø¶ Ø´Ø±ÙŠØ· ØªÙ‚Ø¯Ù… Ø­Ù‚ÙŠÙ‚ÙŠ.
  - Ø¯Ø¹Ù… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ø¨ÙƒØ±Ø§Ù‹.
*/

/* ---- Ø¥Ù†Ø´Ø§Ø¡ Worker (Ù…Ù„Ù Ø®Ø§Ø±Ø¬ÙŠ) ---- */
let worker = null;
let workerUrl = null;
function createWorker() {
    if (worker) return worker;
    // Ù†Ø­Ù…Ù‘Ù„ Ù…Ù„Ù worker.js Ù…Ù† Blob (Ù…Ø¶Ù…Ù‘Ù† Ø¯Ø§Ø®Ù„ index.html Ø¨ÙˆØ§Ø³Ø·Ø© Ù…Ø³Ø§Ø± Ø¯Ø§Ø®Ù„ÙŠ)
    // Ù‡Ø°Ø§ ÙŠØ³Ù…Ø­ Ø¨ÙˆØ¶Ø¹ worker.js Ù…Ù†ÙØµÙ„ ÙÙŠ Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„.
    const workerCode = WORKER_JS_CODE; // Ø³ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡ Ù„Ø§Ø­Ù‚Ù‹Ø§ Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ø¯Ø±Ø§Ø¬
    const blob = new Blob([workerCode], { type: 'application/javascript' });
    workerUrl = URL.createObjectURL(blob);
    worker = new Worker(workerUrl);
    return worker;
}

/* ---- Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ---- */
const folderInput = document.getElementById('folderInput');
const mergeBtn = document.getElementById('mergeBtn');
const extractBtn = document.getElementById('extractBtn');
const copySingleBtn = document.getElementById('copySingleBtn');
const cancelBtn = document.getElementById('cancelBtn');
const singleKeywordInput = document.getElementById('singleKeywordInput');
const startOnlyCheckbox = document.getElementById('startOnlySingleCheckbox');
const singleKeywordOutput = document.getElementById('singleKeywordOutput');
const progressContainer = document.getElementById('progressContainer');
const progressBar = document.getElementById('progressBar');
const exportBtn = document.getElementById('exportBtn');
const dedupBtn = document.getElementById('dedupBtn');

let processing = false;

/* --- ØªÙ‡ÙŠØ¦Ø© Worker ÙˆØ§Ù„Ø±Ø¨Ø· Ø¨Ø­Ø¯Ø«Ø§ØªÙ‡ --- */
function initWorkerHandlers() {
    createWorker();
    worker.onmessage = (e) => {
        const msg = e.data;
        if (msg.type === 'progress') {
            progressContainer.style.display = 'block';
            progressBar.style.width = msg.progress + '%';
        } else if (msg.type === 'extractedLines') {
            // ÙŠØ¹Ø±Ø¶ Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬ (Ù…Ù‚ØªØ·Ù) ØªØ¯Ø±ÙŠØ¬ÙŠØ§Ù‹
            singleKeywordOutput.value = msg.text;
        } else if (msg.type === 'finished') {
            // Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¨Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© (Ù…ØµÙÙˆÙØ§Øª Ø§Ù„Ø­Ù‚ÙˆÙ„)
            applyFields(msg.fields);
            singleKeywordOutput.value = msg.rawExtractedText || singleKeywordOutput.value;
            progressBar.style.width = '100%';
            setTimeout(() => { progressContainer.style.display = 'none'; progressBar.style.width = '0%'; }, 400);
            processing = false;
        } else if (msg.type === 'log') {
            //console.log('worker:', msg.msg);
        } else if (msg.type === 'error') {
            alert('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©: ' + msg.msg);
            processing = false;
            progressContainer.style.display = 'none';
            progressBar.style.width = '0%';
        }
    };
}

/* --- ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø¹Ù„Ù‰ Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© --- */
function applyFields(fields) {
    for (let i = 0; i < 7; i++) {
        const text = (fields[i] || []).join('\n');
        document.getElementById('field' + i).value = text;
        document.getElementById('count' + i).textContent = (fields[i] || []).length + ' Ø³Ø·Ø±';
    }
}

/* --- Ø¯Ù…Ø¬ Ø§Ù„Ù…Ù„ÙØ§Øª ÙˆØ¥Ø±Ø³Ø§Ù„Ù‡Ø§ Ù„Ù„Worker ÙƒØ¯ÙØ¹Ø§Øª (stream) --- */
async function mergeFolderTxt() {
    if (processing) return;
    const files = Array.from(folderInput.files).filter(f => f.name.toLowerCase().endsWith('.txt') || f.name.toLowerCase().endsWith('.html'));
    if (!files.length) { alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø¬Ù„Ø¯ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù…Ù„ÙØ§Øª .txt Ø£Ùˆ .html'); return; }
    files.sort((a,b) => a.name.localeCompare(b.name));

    processing = true;
    initWorkerHandlers();

    // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø¥Ù„Ù‰ Ø§Ù„Worker
    worker.postMessage({
        type: 'config',
        keywords: singleKeywordInput.value,
        startOnly: startOnlyCheckbox.checked
    });

    // Ù‚Ø±Ø§Ø¡Ø© ÙƒÙ„ Ù…Ù„Ù Ø¨Ø§Ù„ØªØªØ§Ø¨Ø¹ ÙˆØ¥Ø±Ø³Ø§Ù„ chunks Ù„Ù„worker
    let totalBytes = files.reduce((s,f) => s + f.size, 0);
    let processedBytes = 0;

    for (const f of files) {
        if (!processing) break;
        // Ù†Ø®Ø¨Ø± Ø§Ù„Worker Ø¹Ù† Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù Ø­ØªÙ‰ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© ÙØ§ØµÙ„ Ù„Ùˆ Ø£Ø±Ø¯Ù†Ø§ Ø°Ù„Ùƒ
        worker.postMessage({ type: 'fileStart', name: f.name });

        // Ù†Ø³ØªØ®Ø¯Ù… stream Ø¥Ù† ÙˆÙØ¬Ø¯
        if (f.stream && typeof f.stream === 'function') {
            const reader = f.stream().getReader();
            const decoder = new TextDecoder('utf-8');
            let done = false;
            while (!done) {
                const { value, done: rDone } = await reader.read();
                done = rDone;
                if (value) {
                    const chunkText = decoder.decode(value, { stream: !done });
                    worker.postMessage({ type: 'fileChunk', chunk: chunkText });
                    processedBytes += value.byteLength;
                    const progress = Math.min(99, Math.floor((processedBytes / totalBytes) * 100));
                    worker.postMessage({ type: 'progressHint', progress });
                }
            }
        } else {
            // fallback: FileReader (ÙŠÙ‚Ø±Ø£ Ø§Ù„Ù…Ù„Ù ÙƒØ§Ù…Ù„Ø§Ù‹ Ù„ÙƒÙ† Ù†Ù‚ÙˆÙ… Ø¨Ø§Ù„ØªØªØ§Ø¨Ø¹ Ø¨ÙŠÙ† Ø§Ù„Ù…Ù„ÙØ§Øª)
            const text = await f.text();
            worker.postMessage({ type: 'fileChunk', chunk: text });
            processedBytes += f.size;
            const progress = Math.min(99, Math.floor((processedBytes / totalBytes) * 100));
            worker.postMessage({ type: 'progressHint', progress });
        }

        // Ù†Ø®Ø¨Ø± Ø§Ù„Worker Ø¨Ø£Ù† Ø§Ù„Ù…Ù„Ù Ø§Ù†ØªÙ‡Ù‰
        worker.postMessage({ type: 'fileEnd', name: f.name });
    }

    // Ø£Ø®ÙŠØ±Ø§Ù‹ Ù†Ø·Ù„Ø¨ Ù…Ù† Ø§Ù„Worker Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
    worker.postMessage({ type: 'finalize' });
}

/* --- Ø±Ø¨Ø· Ø£Ø²Ø±Ø§Ø± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© --- */
mergeBtn.addEventListener('click', mergeFolderTxt);
extractBtn.addEventListener('click', () => {
    // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ø¨Ø§Ø´Ø± Ø¹Ø¨Ø± Ø§Ù„Worker Ù…Ù† Ù…Ø­ØªÙˆÙ‰ current merged (Ø³ÙŠØ¹ÙŠØ¯ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„)
    if (!worker) initWorkerHandlers();
    worker.postMessage({ type: 'config', keywords: singleKeywordInput.value, startOnly: startOnlyCheckbox.checked });
    worker.postMessage({ type: 'reprocess' });
});
copySingleBtn.addEventListener('click', () => {
    navigator.clipboard.writeText(singleKeywordOutput.value).catch(()=>{});
});
cancelBtn.addEventListener('click', () => {
    // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© ÙˆØ¥Ù„ØºØ§Ø¡ Ø§Ù„Worker Ø¥Ø°Ø§ ÙƒØ§Ù† Ù†Ø´Ø·Ø§Ù‹
    processing = false;
    if (worker) {
        worker.terminate();
        worker = null;
        if (workerUrl) { URL.revokeObjectURL(workerUrl); workerUrl = null; }
    }
    progressContainer.style.display = 'none';
    progressBar.style.width = '0%';
});

/* --- Ù†Ø³Ø® Ø­Ù‚Ù„ Ù…Ø¹ÙŠÙ† --- */
function copyField(n) {
    const f = document.getElementById('field' + n);
    navigator.clipboard.writeText(f.value).catch(()=>{});
}

/* --- Ù…Ø³Ø­ Ø§Ù„ØªÙƒØ±Ø§Ø± + Ù†Ø³Ø® Ø¨Ø¹Ø¯ 2 Ø«Ø§Ù†ÙŠØ© --- */
dedupBtn.addEventListener('click', () => {
    removeDuplicatesBasedOnField1();
    setTimeout(() => copyExcelData(), 2000);
});

/* --- ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ Excel --- */
exportBtn.addEventListener('click', () => {
    exportToExcel();
});

/* --- Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© (Ø§Ø³ØªÙ†Ø³Ø® Ù…Ù† Ù…Ù„ÙÙƒ Ø§Ù„Ø£ØµÙ„ÙŠ Ù…Ø¹ ØªØ­Ø³ÙŠÙ† Ø·ÙÙŠÙ) --- */
function parseFrenchDateToDDMMYYYY(str) {
    const months = {
        janvier: "01", fÃ©vrier: "02", fevrier: "02", mars: "03", avril: "04", mai: "05",
        juin: "06", juillet: "07", aoÃ»t: "08", aout: "08", septembre: "09",
        octobre: "10", novembre: "11", dÃ©cembre: "12", decembre: "12"
    };
    const dateString = str.replace(/^(?:\w+\s+)+(\d{1,2})\s+([a-zÃ©Ã»]+)\s+(\d{4})\s+\d{1,2}:\d{2}$/, '$1 $2 $3');
    const match = dateString.match(/(\d{1,2})\s+([a-zÃ©Ã»]+)\s+(\d{4})/i);
    if (match) {
        const day = match[1].padStart(2, "0");
        const month = months[match[2].toLowerCase()] || "01";
        const year = match[3];
        return `${day}/${month}/${year}`;
    }
    return "";
}

function exportToExcel() {
    const numFields = 7, fieldsData = [];
    for (let i = 0; i < numFields; i++) fieldsData[i] = document.getElementById("field"+i).value.split("\n");
    const maxRows = Math.max(...fieldsData.map(arr => arr.length));
    const wsData = [];
    for (let r = 0; r < maxRows; r++) {
        const rawDateLine = fieldsData[0][r] || "";
        const parsedDate = parseFrenchDateToDDMMYYYY(rawDateLine);
        wsData[r] = [
            fieldsData[1][r] || "",
            fieldsData[4][r] || "",
            parsedDate || "",
            parsedDate || "",
            fieldsData[5][r] || "",
            fieldsData[6][r] || "",
            parsedDate || "",
            (fieldsData[6][r] || "").trim().split(/\s+/)[0] || "CASABLANCA",
            fieldsData[3][r] || "",
            fieldsData[2][r] || "",
            "", "", parsedDate || ""
        ];
    }
    const ws = XLSX.utils.aoa_to_sheet(wsData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
    XLSX.writeFile(wb, "extracted_data.xlsx");
}

/* --- Ø­Ø°Ù Ø§Ù„ØªÙƒØ±Ø§Ø± Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø­Ù‚Ù„ 1 (ID CASE) --- */
function removeDuplicatesBasedOnField1() {
    const numFields = 7, fieldsData = [];
    for (let i = 0; i < numFields; i++) fieldsData[i] = document.getElementById("field"+i).value.split("\n");
    const maxRows = Math.max(...fieldsData.map(arr => arr.length));
    const seen = new Set(), uniqueRows = [];
    for (let r = 0; r < maxRows; r++) {
        const v = (fieldsData[1][r] || "").trim();
        if (!seen.has(v) && v !== "") {
            seen.add(v);
            const row = [];
            for (let c = 0; c < numFields; c++) row.push(fieldsData[c][r] || "");
            uniqueRows.push(row);
        }
    }
    const newFields = Array.from({ length: numFields }, () => []);
    uniqueRows.forEach(row => { for (let c = 0; c < numFields; c++) newFields[c].push(row[c]); });
    for (let i = 0; i < numFields; i++) {
        document.getElementById("field"+i).value = newFields[i].join("\n");
        document.getElementById("count"+i).textContent = newFields[i].length + " Ø³Ø·Ø±";
    }
}

/* --- Ù†Ø³Ø® Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥ÙƒØ³Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø© (Ù…Ø³ØªØ®Ø¯Ù…Ø© Ø¨Ø¹Ø¯ Ø­Ø°Ù Ø§Ù„ØªÙƒØ±Ø§Ø±) --- */
function copyExcelData() {
    const numFields = 7, fieldsData = [];
    for (let i = 0; i < numFields; i++) fieldsData[i] = document.getElementById("field"+i).value.split("\n");
    const maxRows = Math.max(...fieldsData.map(arr => arr.length));
    let text = "";
    for (let r = 0; r < maxRows; r++) {
        const rawDate = fieldsData[0][r] || "", parsedDate = parseFrenchDateToDDMMYYYY(rawDate);
        const firstWord = (fieldsData[6][r] || "").trim().split(/\s+/)[0] || "CASABLANCA";
        const rowData = [
            fieldsData[1][r] || "",
            fieldsData[4][r] || "",
            parsedDate || "",
            parsedDate || "",
            fieldsData[5][r] || "",
            fieldsData[6][r] || "",
            parsedDate || "",
            firstWord,
            fieldsData[3][r] || "",
            fieldsData[2][r] || "",
            "", "", parsedDate || ""
        ];
        text += rowData.join("\t") + "\n";
    }
    navigator.clipboard.writeText(text).catch(()=>{});
}

/* ---- ØªØ­Ù…ÙŠÙ„ ÙƒÙˆØ¯ Ø§Ù„Worker Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…ØªØºÙŠØ± WORKER_JS_CODE ---- */
/* Ù„ØªØ³Ù‡ÙŠÙ„ Ø§Ù„Ù†Ø´Ø± Ø¶Ù…Ù† Ù…Ù„Ù ÙˆØ§Ø­Ø¯ Ù‚Ù…Øª Ø¨ØªØ¶Ù…ÙŠÙ† ÙƒÙˆØ¯ worker ÙƒÙ€ string Ø£Ø¯Ù†Ø§Ù‡.
   ÙÙŠ Ø­Ø§Ù„ Ø±ØºØ¨Øª ÙŠÙ…ÙƒÙ†Ùƒ Ù†Ù‚Ù„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¥Ù„Ù‰ Ù…Ù„Ù Ù…Ù†ÙØµÙ„ worker.js ÙˆØ§Ø³ØªØ¨Ø¯Ø§Ù„ createObjectURL accordingly.
*/
const WORKER_JS_CODE = `
/* Worker: Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¯Ù…Ø¬ ÙˆØ§Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ ØªØ¯Ø±ÙŠØ¬ÙŠØ§Ù‹ */
let keywords = [];
let startOnly = true;

let bufferLines = []; // buffer lines until we find extraction triggers
let skipMode = false;
let extractedLines = []; // Ù†Øµ ØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬Ù‡ (Ø³Ù„Ø³Ù„Ø©)
let fields = [[],[],[],[],[],[],[]]; // EnvoyÃ©, ID, Client, Tel, Reseau, Activites, Adresse

function postProgress(p) {
    postMessage({ type: 'progress', progress: p });
}

function decodeCorruptedCharacters(text) {
    return text
        .replace(/ï¿½/g, "Ã©")
        .replace(/ÃƒÂ©/g, "Ã©")
        .replace(/ÃƒÂ¨/g, "Ã¨")
        .replace(/Ãƒ/g, "Ã ")
        .replace(/ÃƒÂ´/g, "Ã´")
        .replace(/ÃƒÂª/g, "Ãª")
        .replace(/ÃƒÂ¢/g, "Ã¢")
        .replace(/ÃƒÂ¼/g, "Ã¼")
        .replace(/ÃƒÂ§/g, "Ã§")
        .replace(/Ã‚/g, "")
        .replace(/[^\x00-\x7F]/g, c => c);
}

function normalizePhone(phone) {
    const s = phone.trim();
    return s.startsWith("0") ? s.substring(1) : s;
}

function startsWithAnyStrict(line, list) {
    line = line.trimStart();
    for (let k of list) {
        const esc = k.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\\\$&');
        const re = new RegExp("^" + esc + "\\s*:", "i");
        if (re.test(line)) return k;
    }
    return null;
}

/* ØªØ­Ù„ÙŠÙ„ Ø£Ø³Ø·Ø± Ø§Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ (Ù…Ø«Ù„ Ø§Ù„Ø¯Ø§Ù„Ø© filterAndDistribute Ø§Ù„Ø£ØµÙ„ÙŠØ©) */
function consumeExtractedLines(linesArr) {
    // linesArr: array of lines from one extracted block (could be many)
    let current = {};
    for (const rawLine of linesArr) {
        const line = rawLine.trim();
        if (!line) continue;

        const envoyKey = startsWithAnyStrict(line, ["EnvoyÃ©", "Envoyï¿½", "Sent"]);
        if (envoyKey) { current[0] = cleanValue(line, envoyKey); continue; }
        if (startsWithAnyStrict(line, ["ID CASE"])) { current[1] = cleanValue(line, "ID CASE"); continue; }
        if (startsWithAnyStrict(line, ["Client"])) { current[2] = cleanValue(line, "Client"); continue; }
        const telKey = startsWithAnyStrict(line, ["Tï¿½lï¿½phone", "TÃ©lÃ©phone"]);
        if (telKey) { current[3] = normalizePhone(cleanValue(line, telKey)); continue; }
        const reseauKey = startsWithAnyStrict(line, ["Accï¿½s rï¿½seau", "AccÃ¨s rÃ©seau"]);
        if (reseauKey) { current[4] = normalizePhone(cleanValue(line, reseauKey)); continue; }
        const activitesKey = startsWithAnyStrict(line, ["Activitï¿½s de service", "ActivitÃ©s de service"]);
        if (activitesKey) {
            let rawValue = cleanValue(line, activitesKey);
            let parts = rawValue.split("|");
            let lastPart = parts.length>1 ? parts[parts.length-1].trim() : rawValue.trim();
            lastPart = lastPart.replace(/[^\\w\\s\\u00C0-\\u017F]/g, '').trim();
            current[5] = lastPart;
            continue;
        }
        const adresseKey = startsWithAnyStrict(line, ["Adresse Installation"]);
        if (adresseKey) {
            current[6] = cleanValue(line, "Adresse Installation");
            // flush record
            for (let j=0;j<=6;j++) fields[j].push(current[j] || "");
            current = {};
            continue;
        }
        // Ù‚ÙŠÙ‘Ù… Ø­Ø§Ù„ ÙˆØ¬ÙˆØ¯ Ø³Ø·Ø± ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ':' ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠØ³Ø§Ø¹Ø¯ Ø¹Ù„Ù‰ Ø§Ù„ØªÙ‚Ø§Ø· Ù‚ÙŠÙ… Ù…ÙÙ‚ÙˆØ¯Ø©
        if (line.includes(":")) {
            const key = line.split(":")[0].trim();
            if (["EnvoyÃ©","Sent","Envoyï¿½"].some(k=>k.toLowerCase()===key.toLowerCase())) current[0] = cleanValue(line,key);
            else if (key.toLowerCase().includes("id")) current[1] = cleanValue(line,key);
            else if (key.toLowerCase().includes("client")) current[2] = cleanValue(line,key);
        }
    }
}

function cleanValue(line, keyword) {
    let value = "";
    if (line.includes(":")) value = line.split(":").slice(1).join(":").trim();
    else value = line.replace(new RegExp("^" + keyword.replace(/[-\\/\\\\^$*+?.()|[\\]{}]/g,'\\\\$&'), "i"), "").trim();
    return decodeCorruptedCharacters(value);
}

/* --- Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù…Ù† Ø§Ù„Main thread --- */
let partial = ""; // Ø¬Ø²Ø¡ Ù…Ù† chunk Ù„Ù… ÙŠÙÙ†Ù‡ÙŠ Ø¨Ø³Ø·Ø±
let totalHintProgress = 0;

onmessage = function(e) {
    try {
        const msg = e.data;
        if (msg.type === 'config') {
            keywords = (msg.keywords || "").split(",").map(s=>s.trim()).filter(Boolean);
            startOnly = !!msg.startOnly;
            postMessage({ type:'log', msg: 'config set' });
        } else if (msg.type === 'fileStart') {
            // ÙŠÙ…ÙƒÙ†Ù†Ø§ Ø¥Ø¶Ø§ÙØ© ÙØ§ØµÙ„ Ù„ØªÙ…ÙŠÙŠØ² Ø§Ù„Ù…Ù„ÙØ§Øª Ø¥Ù† Ø£Ø±Ø¯Ù†Ø§ØŒ Ù†Ø±Ø³Ù„ Ø³Ø·Ø± ÙØ§ØµÙ„ Ø£ÙŠØ¶Ø§Ù‹
            partial += "\\n===== " + (msg.name||"file") + " =====\\n";
        } else if (msg.type === 'fileChunk') {
            // Ø§Ø³ØªÙ„Ø§Ù… Ø¬Ø²Ø¡ Ù…Ù† Ø§Ù„Ù†Øµ â€” Ù†Ù‚Ø³Ù… Ø¥Ù„Ù‰ Ø£Ø³Ø·Ø±ØŒ ÙˆÙ†Ø¹Ø§Ù„Ø¬ Ø£ÙŠ Ø£Ø³Ø·Ø± Ù…Ø³ØªØ®Ø±Ø¬Ø© Ù…Ø¨Ø§Ø´Ø±Ø© Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø°Ø§ÙƒØ±Ø©
            const combined = partial + (msg.chunk || "");
            const parts = combined.split(/\\r?\\n/);
            partial = parts.pop() || ""; // Ø¢Ø®Ø± Ø¬Ø²Ø¡ ØºÙŠØ± Ù…ÙƒØªÙ…Ù„ ÙŠØ¨Ù‚Ù‰ ÙÙŠ partial

            // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø³Ø·Ø± Ø§Ù„Ù…ØªØ§Ø­Ø©
            for (const line of parts) {
                processLineForExtraction(line);
            }
            // Ù†Ø±Ø³Ù„ ØªØ­Ø¯ÙŠØ« Ù„Ù„Ù†Øµ Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬ (Ù…Ø®ØªØµØ± Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ù†Ù‚Ù„)
            if (extractedLines.length > 0) {
                postMessage({ type:'extractedLines', text: extractedLines.join("\\n") });
            }
        } else if (msg.type === 'fileEnd') {
            // Ù†ÙƒÙ…Ù„ Ù…Ø§ ØªØ¨Ù‚Ù‰ ÙÙŠ partial ÙƒØ³Ø·Ø± ÙˆØ§Ø­Ø¯
            if (partial) {
                processLineForExtraction(partial);
                partial = "";
            }
            // Ù†Ø¶ÙŠÙ ÙØ§ØµÙ„ Ù†Ù‡Ø§ÙŠØ© Ù…Ù„Ù
            // (Ù„Ø§ Ø­Ø§Ø¬Ø© Ø­Ø§Ù„ÙŠØ§Ù‹)
        } else if (msg.type === 'progressHint') {
            totalHintProgress = msg.progress || totalHintProgress;
            postProgress(totalHintProgress);
        } else if (msg.type === 'finalize') {
            // flush Ø£ÙŠ Ø¬Ø²Ø¦ÙŠØ§ØªØŒ Ø¥Ù†Ù‡Ø§Ø¡ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
            if (partial) { processLineForExtraction(partial); partial = ""; }
            postMessage({ type:'finished', fields: fields, rawExtractedText: extractedLines.join("\\n") });
            // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Worker (Ù„ÙŠØ³Øª Ø¶Ø±ÙˆØ±ÙŠØ© Ø¯Ø§Ø¦Ù…Ø§Ù‹)
            //fields = [[],[],[],[],[],[],[]];
        } else if (msg.type === 'reprocess') {
            // ÙÙŠ Ø­Ø§Ù„ Ø£Ø±Ø¯Ù†Ø§ Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ø§ Ù†Ù…Ù„Ùƒ (Ù„Ù… Ù†Ø·Ø¨Ù‚ ØªØ®Ø²ÙŠÙ† Ù„Ù„Ù†Øµ Ø§Ù„ÙƒØ§Ù…Ù„ Ù‡Ù†Ø§)
            postMessage({ type:'log', msg: 'reprocess requested but not implemented in worker' });
        }
    } catch (err) {
        postMessage({ type:'error', msg: err && err.message ? err.message : String(err) });
    }
};

/* --- Ù…Ù†Ø·Ù‚ Ø§Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ø£Ø«Ù†Ø§Ø¡ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø£Ø³Ø·Ø± --- */
const skipKeywords = ["sans", "SANS"];

function processLineForExtraction(rawLine) {
    const line = rawLine || "";
    // skip logic
    if (skipKeywords.some(w => line.toLowerCase().includes(w.toLowerCase()))) {
        bufferLines = [];
        skipMode = true;
        return;
    }
    if (skipMode && line.includes("Adresse Installation")) {
        skipMode = false;
        return;
    }
    bufferLines.push(line);

    // Ù†ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø£ÙŠ Ù…Ù† Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…ÙØªØ§Ø­ÙŠØ© ÙŠØ¨Ø¯Ø£ Ø¨Ù‡Ø§ Ø§Ù„Ø³Ø·Ø± (Ø­Ø³Ø¨ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ startOnly Ø£Ùˆ Ù„Ø§)
    const matched = keywords.some(k => {
        if (!k) return false;
        if (startOnly) {
            return line.trim().toLowerCase().startsWith(k.toLowerCase());
        } else {
            return line.toLowerCase().includes(k.toLowerCase());
        }
    });

    if (matched) {
        // Ø£Ø¶Ù bufferLines Ø¥Ù„Ù‰ extractedLines (Ù„ÙŠØ³ ÙƒÙ„ Ø§Ù„Ø³Ø·ÙˆØ± Ù‚Ø¯ ØªÙƒÙˆÙ† Ù…ÙÙŠØ¯Ø© Ù„ÙƒÙ† Ù†Ø­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ø³Ù„ÙˆÙƒÙƒ Ø§Ù„Ø£ØµÙ„ÙŠ)
        extractedLines.push(...bufferLines);
        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ø¨Ø§Ø´Ø±Ø© Ù„Ø®Ø·ÙˆØ· Ø§Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ (Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ø¥Ù„Ù‰ Ø§Ù„Ø­Ù‚ÙˆÙ„)
        consumeExtractedLines(bufferLines);
        bufferLines = [];
    }
}
`;

/* Ø§Ù†ØªÙ‡Ù‰ ÙƒÙˆØ¯ Ø§Ù„Worker Ø§Ù„Ù…Ø¶Ù…Ù‘Ù† */
</script>
</body>
</html>
