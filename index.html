<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <title>Protected JS Demo</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
</head>
<body>
  <h1>جاري تحميل الشفرة المشفرة…</h1>

<!-- أضف هذا داخل <head> أو قبل سكريبتاتك -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

<script>
  // المفتاح: 16 حرف (128 بت)
  const key = CryptoJS.enc.Utf8.parse("12345MySecretKey");

  function encryptAES(text) {
    return CryptoJS.AES.encrypt(text, key, {
      mode: CryptoJS.mode.ECB,
      padding: CryptoJS.pad.Pkcs7
    }).toString();
  }

  function decryptAES(ciphertext) {
    const decrypted = CryptoJS.AES.decrypt(ciphertext, key, {
      mode: CryptoJS.mode.ECB,
      padding: CryptoJS.pad.Pkcs7
    });
    return decrypted.toString(CryptoJS.enc.Utf8);
  }

  // تعطيل الزر الأيمن
  document.addEventListener("contextmenu", function(e) {
    e.preventDefault();
  });

  // تعطيل بعض اختصارات لوحة المفاتيح
  document.addEventListener("keydown", function(e) {
    if (
      e.key === "F12" ||
      (e.ctrlKey && e.key.toLowerCase() === "u") ||    // Ctrl+U
      (e.ctrlKey && e.key.toLowerCase() === "s") ||    // Ctrl+S
      (e.ctrlKey && e.shiftKey && (e.key === "I" || e.key === "J")) // Ctrl+Shift+I/J
    ) {
      e.preventDefault();
      return false;
    }
  });

  let originalMergedContent = "";

  // دمج ملفات TXT مع التشفير
  function mergeFolderTxt() {
    const input = document.getElementById("folderInput");
    const files = input.files;

    if (!files.length) {
      alert("يرجى اختيار مجلد يحتوي على ملفات .txt.");
      return;
    }

    let mergedContent = "";
    let filesProcessed = 0;

    const txtFiles = Array.from(files).filter((file) =>
      file.name.toLowerCase().endsWith(".txt")
    );

    if (txtFiles.length === 0) {
      alert("لا يوجد ملفات .txt في هذا المجلد.");
      return;
    }

    txtFiles.sort((a, b) => a.name.localeCompare(b.name));

    txtFiles.forEach((file) => {
      const reader = new FileReader();
      reader.onload = function (e) {
        mergedContent += `\n===== ${file.name} =====\n` + e.target.result + "\n";
        filesProcessed++;
        if (filesProcessed === txtFiles.length) {
          originalMergedContent = mergedContent;

          // تشفير المحتوى المدموج قبل عرضه
          const encryptedContent = encryptAES(mergedContent);
          document.getElementById("filteredOutput").value = encryptedContent;

          // استخراج الكلمات بعد الدمج (لو تحتاج فك التشفير قبل الاستخراج)
          // فك التشفير داخل extractSingleKeyword() - سنعدلها للتعامل مع النص المشفر
          extractSingleKeyword(true); // true تعني ان المحتوى مشفر
        }
      };
      reader.readAsText(file);
    });
  }

  // تعديل دالة استخراج الكلمات لتدعم النص المشفر
  function extractSingleKeyword(isEncrypted = false) {
    const keywordText = document.getElementById("singleKeywordInput").value.trim();
    const startOnly = document.getElementById("startOnlySingleCheckbox").checked;

    if (!keywordText) {
      alert("يرجى كتابة كلمة أو أكثر مفصولة بفاصلة للاستخراج.");
      return;
    }

    const keywords = keywordText.split(",").map(k => k.trim()).filter(k => k.length > 0);

    // فك التشفير إذا المحتوى مشفر
    let textToSearch = document.getElementById("filteredOutput").value;
    if (isEncrypted) {
      textToSearch = decryptAES(textToSearch);
    }

    const lines = textToSearch.split("\n");
    const extractedLines = [];

    for (const line of lines) {
      const cleanLine = line.trim();
      for (const keyword of keywords) {
        if (
          (startOnly && cleanLine.startsWith(keyword)) ||
          (!startOnly && cleanLine.includes(keyword))
        ) {
          extractedLines.push(cleanLine);
          break;
        }
      }
    }

    document.getElementById("singleKeywordOutput").value = extractedLines.join("\n");

    // بعد الاستخراج يتم تنفيذ الفلترة والتوزيع تلقائياً
    filterAndDistribute();
  }

  // بقية دوالك (copyFiltered, copySingleKeyword, filterAndDistribute, ... ) بدون تعديل
  // فقط تأكد ان extractSingleKeyword تُستدعى مع معامل isEncrypted بشكل صحيح حسب الحاجة

  // --- باقي الكود بدون تعديل ---

  // نسخ النص الكامل (من الموقع الأول)
  function copyFiltered() {
    const textArea = document.getElementById("filteredOutput");
    textArea.select();
    document.execCommand("copy");
    window.getSelection().removeAllRanges();
  }

  // نسخ نتائج الاستخراج (الموقع الأول)
  function copySingleKeyword() {
    const textArea = document.getElementById("singleKeywordOutput");
    textArea.select();
    document.execCommand("copy");
    window.getSelection().removeAllRanges();
  }

  // ... باقي دوال فلترة وتوزيع ونسخ وتصدير إلى Excel كما في الكود الأصلي ...

  // أنصحك فقط في دوال تستخدم محتوى filteredOutput أن تضيف فك التشفير قبل المعالجة
  // أو تعرض نص مفكوك للمستخدم مع زر فك تشفير إضافي حسب حاجتك
</script>
</body>
</html>




