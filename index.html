<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <title>EXTRACTION CANVAS</title>
  <style>
    body {
      direction: rtl;
      font-family: Arial, sans-serif;
      margin: 0; padding: 20px;
      display: flex;
      gap: 20px;
      height: 100vh;
      box-sizing: border-box;
    }
    .container {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      border: 1px solid #ccc;
      padding: 15px;
      border-radius: 5px;
      box-shadow: 1px 1px 5px rgba(0,0,0,0.1);
    }
    h2 {
      margin-top: 0;
      text-align: center;
    }
    input[type="file"] {
      margin-bottom: 10px;
    }
    button {
      padding: 10px;
      font-size: 16px;
      cursor: pointer;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      margin-bottom: 15px;
      transition: background-color 0.3s ease;
    }
    button:hover {
      background-color: #0056b3;
    }
    textarea, input[type="text"] {
      width: 100%;
      padding: 10px;
      font-size: 13px;
      margin-bottom: 10px;
      box-sizing: border-box;
      resize: vertical;
      font-family: monospace, monospace;
    }
    .row {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }
    .field-container {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    .field-container textarea {
      height: 90px;
      resize: vertical;
    }
    .copy-button {
      margin-top: 5px;
      background-color: #28a745;
    }
    .copy-button:hover {
      background-color: #1e7e34;
    }
    .line-count {
      font-weight: bold;
      margin-bottom: 5px;
      color: #007bff;
      text-align: center;
      user-select: none;
    }
    label {
      font-weight: bold;
      margin-bottom: 5px;
      display: block;
    }
    /* Ø¥Ø®ÙØ§Ø¡ Ø®Ø§Ù†Ø© Ø§Ù„ÙƒÙ„Ù…Ø§Øª (Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø«Ø§Ù†ÙŠ) */
    #keyword, label[for="keyword"] {
      display: none;
    }
  </style>

  <!-- Ù…ÙƒØªØ¨Ø© SheetJS -->
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
</head>
<body>

  <!-- Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø£ÙˆÙ„ - Ø±ÙØ¹ ÙˆØ¯Ù…Ø¬ Ù…Ù„ÙØ§Øª TXT -->
  <div class="container" style="max-width: 45%;">
<h1 style="text-align: center;">ğŸ“ EXTRACTION CANVAS ğŸ“</h1>
    <input type="file" id="folderInput" webkitdirectory directory multiple accept=".txt" />
    <button onclick="mergeFolderTxt()">Ø¯Ù…Ø¬ Ø§Ù„Ù…Ù„ÙØ§Øª</button>

    <!-- Ø§Ù„Ù†Øµ Ø¨Ø¹Ø¯ Ø§Ù„Ø¯Ù…Ø¬ Ù…Ø®ÙÙŠ -->
    <textarea id="filteredOutput" rows="10" style="display:none;"></textarea>

    <h3>ğŸ” Ø§Ø³ØªØ®Ø±Ø§Ø¬ ÙƒÙ„Ù…Ø§Øª Ù…ØªØ¹Ø¯Ø¯Ø© (Ù…ÙØµÙˆÙ„Ø© Ø¨ÙØ§ØµÙ„Ø©)</h3>
    <input
      type="text"
      id="singleKeywordInput"
      value="ID CASE,Client :,Tï¿½lï¿½phone,Accï¿½s rï¿½seau,Activitï¿½s de service,Commentaire,Adresse Installation"
      placeholder="Ø§ÙƒØªØ¨ ÙƒÙ„Ù…Ø© Ø£Ùˆ Ø£ÙƒØ«Ø± Ù…ÙØµÙˆÙ„Ø© Ø¨ÙØ§ØµÙ„Ø©"
    />
    <label>
      <input type="checkbox" id="startOnlySingleCheckbox" checked />
      Ø§Ø³ØªØ®Ø±Ø§Ø¬ ÙÙ‚Ø· Ø§Ù„Ø£Ø³Ø·Ø± Ø§Ù„ØªÙŠ <strong>ØªØ¨Ø¯Ø£</strong> Ø¨Ø§Ù„ÙƒÙ„Ù…Ø§Øª
    </label><br />
    <button onclick="extractSingleKeyword()">ğŸ” Ø§Ø³ØªØ®Ø±Ø§Ø¬</button>
    <textarea id="singleKeywordOutput" rows="7" readonly placeholder="Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ Ø§Ù„Ø£Ø³Ø·Ø± Ø§Ù„ØªÙŠ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©"></textarea>
    <button onclick="copySingleKeyword()" class="copy-button">ğŸ“‹ Ù†Ø³Ø® Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬</button>
  </div>

  <!-- Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø«Ø§Ù†ÙŠ - Ø§Ù„ÙÙ„ØªØ±Ø© ÙˆØ§Ù„ØªÙˆØ²ÙŠØ¹ -->
  <div class="container" style="max-width: 50%;">
    <label for="keyword">ğŸ” Ø§Ù„ÙƒÙ„Ù…Ø§Øª (Ø§ÙØµÙ„ Ø¨ÙŠÙ†Ù‡Ø§ Ø¨Ù€ +):</label>
    <input type="text" id="keyword" placeholder="Ù…Ø«Ø§Ù„: Ø®Ø·Ø£+ÙØ´Ù„+ØªØ­Ø°ÙŠØ±" value="SANS CA" />
    <button onclick="filterAndDistribute()" style="display:none;">ğŸš€ ØªÙ†ÙÙŠØ°</button>
<!-- ğŸŸ¦ Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„: Ø®Ø§Ù†Ø§Øª 1ØŒ 2ØŒ 3 -->
<div class="row">
  <div class="field-container">
    <div class="line-count" id="count1">0 Ø³Ø·Ø±</div>
    <textarea id="field1" readonly></textarea>
    <button class="copy-button" onclick="copyField(1)">ğŸ“‹ Ù†Ø³Ø® Ø§Ù„Ø®Ø§Ù†Ø© 1</button>
  </div>
  <div class="field-container">
    <div class="line-count" id="count2">0 Ø³Ø·Ø±</div>
    <textarea id="field2" readonly></textarea>
    <button class="copy-button" onclick="copyField(2)">ğŸ“‹ Ù†Ø³Ø® Ø§Ù„Ø®Ø§Ù†Ø© 2</button>
  </div>
  <div class="field-container">
    <div class="line-count" id="count3">0 Ø³Ø·Ø±</div>
    <textarea id="field3" readonly></textarea>
    <button class="copy-button" onclick="copyField(3)">ğŸ“‹ Ù†Ø³Ø® Ø§Ù„Ø®Ø§Ù†Ø© 3</button>
  </div>
</div>

<!-- âœ… Ø§Ù„ØªØ§Ø±ÙŠØ®: ÙÙŠ Ø§Ù„Ù…Ù†ØªØµÙ Ø¨ÙŠÙ† Ø§Ù„ØµÙÙŠÙ† -->
<div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap; margin: 20px 0; justify-content: center;">
  <strong>ğŸ—“ï¸ Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong>

  <label style="display: flex; align-items: center; gap: 5px;">
    <input type="radio" name="dateOption" value="today" checked>
    Ø§Ù„ÙŠÙˆÙ…
  </label>

  <label style="display: flex; align-items: center; gap: 5px;">
    <input type="radio" name="dateOption" value="yesterday">
    Ø§Ù„Ø¨Ø§Ø±Ø­Ø©
  </label>

  <label style="display: flex; align-items: center; gap: 5px;">
    <input type="radio" name="dateOption" value="custom">
    Ù…Ø®ØµØµ
  </label>

  <input type="date" id="customDateInput" style="padding: 5px;" />
</div>

<!-- ğŸŸ© Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ: Ø®Ø§Ù†Ø§Øª 4ØŒ 5ØŒ 6 -->
<div class="row">
  <div class="field-container">
    <div class="line-count" id="count4">0 Ø³Ø·Ø±</div>
    <textarea id="field4" readonly></textarea>
    <button class="copy-button" onclick="copyField(4)">ğŸ“‹ Ù†Ø³Ø® Ø§Ù„Ø®Ø§Ù†Ø© 4</button>
  </div>
  <div class="field-container">
    <div class="line-count" id="count5">0 Ø³Ø·Ø±</div>
    <textarea id="field5" readonly></textarea>
    <button class="copy-button" onclick="copyField(5)">ğŸ“‹ Ù†Ø³Ø® Ø§Ù„Ø®Ø§Ù†Ø© 5</button>
  </div>
  <div class="field-container">
    <div class="line-count" id="count6">0 Ø³Ø·Ø±</div>
    <textarea id="field6" readonly></textarea>
    <button class="copy-button" onclick="copyField(6)">ğŸ“‹ Ù†Ø³Ø® Ø§Ù„Ø®Ø§Ù†Ø© 6</button>
  </div>
</div>

<!-- âœ… Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… (ØªØ­Øª Ø§Ù„ÙƒÙ„ØŒ ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ ÙƒØ§Ù†Øª) -->
<div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px;">
  <button onclick="removeDuplicatesBasedOnField1()" style="background-color:#dc3545; color:white;">
    ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„ØªÙƒØ±Ø§Ø± 
  </button>
  <button onclick="copyExcelData()" style="background-color:#28a745; color:white;">
    ğŸ“‹ Ù†Ø³Ø® Ø§Ù„ÙƒÙ„
  </button>
  <button onclick="exportToExcel()" style="background-color:#ff6600; color:white;">
    â¬‡ï¸ ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ Excel
  </button>
</div>





<script>

  // ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø²Ø± Ø§Ù„Ø£ÙŠÙ…Ù†
document.addEventListener("contextmenu", function(e) {
  e.preventDefault();
});

// ØªØ¹Ø·ÙŠÙ„ Ø¨Ø¹Ø¶ Ø§Ø®ØªØµØ§Ø±Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­
document.addEventListener("keydown", function(e) {
  if (
    e.key === "F12" ||
    (e.ctrlKey && e.key.toLowerCase() === "u") ||    // Ctrl+U
    (e.ctrlKey && e.key.toLowerCase() === "s") ||    // Ctrl+S
    (e.ctrlKey && e.shiftKey && (e.key === "I" || e.key === "J")) // Ctrl+Shift+I/J
  ) {
    e.preventDefault();
    return false;
  }
});
  let originalMergedContent = "";

  // Ø¯Ù…Ø¬ Ù…Ù„ÙØ§Øª TXT
function mergeFolderTxt() {
  const input = document.getElementById("folderInput");
  const files = input.files;

  if (!files.length) {
    alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø¬Ù„Ø¯ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù…Ù„ÙØ§Øª .txt.");
    return;
  }

  let mergedContent = "";
  let filesProcessed = 0;

  const txtFiles = Array.from(files).filter((file) =>
    file.name.toLowerCase().endsWith(".txt")
  );

  if (txtFiles.length === 0) {
    alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù„ÙØ§Øª .txt ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¬Ù„Ø¯.");
    return;
  }

  txtFiles.sort((a, b) => a.name.localeCompare(b.name));

  txtFiles.forEach((file) => {
    const reader = new FileReader();
    reader.onload = function (e) {
      mergedContent += `\n===== ${file.name} =====\n` + e.target.result + "\n";
      filesProcessed++;
      if (filesProcessed === txtFiles.length) {
        originalMergedContent = mergedContent;
        document.getElementById("filteredOutput").value = mergedContent;

        // Ù‡Ù†Ø§ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„Ø¯Ù…Ø¬ Ù…Ø¨Ø§Ø´Ø±Ø©
        extractSingleKeyword();
      }
    };
    reader.readAsText(file);
  });
}


  // Ù†Ø³Ø® Ø§Ù„Ù†Øµ Ø§Ù„ÙƒØ§Ù…Ù„ (Ù…Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø£ÙˆÙ„)
  function copyFiltered() {
    const textArea = document.getElementById("filteredOutput");
    textArea.select();
    document.execCommand("copy");
    window.getSelection().removeAllRanges();
  }

  // Ø§Ø³ØªØ®Ø±Ø§Ø¬ ÙƒÙ„Ù…Ø§Øª Ù…ØªØ¹Ø¯Ø¯Ø© Ù…ÙØµÙˆÙ„Ø© Ø¨ÙØ§ØµÙ„Ø© (Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø£ÙˆÙ„)
  function extractSingleKeyword() {
    const keywordText = document.getElementById("singleKeywordInput").value.trim();
    const startOnly = document.getElementById("startOnlySingleCheckbox").checked;

    if (!keywordText) {
      alert("ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© ÙƒÙ„Ù…Ø© Ø£Ùˆ Ø£ÙƒØ«Ø± Ù…ÙØµÙˆÙ„Ø© Ø¨ÙØ§ØµÙ„Ø© Ù„Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬.");
      return;
    }

    const keywords = keywordText.split(",").map(k => k.trim()).filter(k => k.length > 0);

    const lines = document.getElementById("filteredOutput").value.split("\n");
    const extractedLines = [];

    for (const line of lines) {
      const cleanLine = line.trim();
      for (const keyword of keywords) {
        if (
          (startOnly && cleanLine.startsWith(keyword)) ||
          (!startOnly && cleanLine.includes(keyword))
        ) {
          extractedLines.push(cleanLine);
          break;
        }
      }
    }

    document.getElementById("singleKeywordOutput").value = extractedLines.join("\n");

    // Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ ÙŠØªÙ… ØªÙ†ÙÙŠØ° Ø§Ù„ÙÙ„ØªØ±Ø© ÙˆØ§Ù„ØªÙˆØ²ÙŠØ¹ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
    filterAndDistribute();
  }

  // Ù†Ø³Ø® Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ (Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø£ÙˆÙ„)
  function copySingleKeyword() {
    const textArea = document.getElementById("singleKeywordOutput");
    textArea.select();
    document.execCommand("copy");
    window.getSelection().removeAllRanges();
  }

  // --- Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø«Ø§Ù†ÙŠ: ÙÙ„ØªØ±Ø© ÙˆØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù†ØµÙˆØµ ---

  function getTextAfterColon(line) {
    const parts = line.split(':');
    return parts.length > 1 ? parts.slice(1).join(':').trim() : line.trim();
  }

  function removeLeadingZero(str) {
    if (/^0\d+$/.test(str)) { // ÙŠØ¨Ø¯Ø£ Ø¨Ù€0 ÙˆÙ…ØªØ¨ÙˆØ¹Ø© Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·
      return str.substring(1);
    }
    return str;
  }

function filterAndDistribute() {
  const text = document.getElementById('singleKeywordOutput').value;
  const keywordInput = document.getElementById('keyword').value.toLowerCase();
  const keywords = keywordInput.split('+').map(k => k.trim()).filter(k => k);
  const lines = text.split('\n');
  const linesToDelete = new Set();

  // Ø­Ø°Ù Ø§Ù„Ø£Ø³Ø·Ø± Ø§Ù„ØªÙŠ ØªØ­ØªÙˆÙŠ ÙƒÙ„Ù…Ø§Øª Ù…ÙØªØ§Ø­ÙŠØ© + 5 Ù‚Ø¨Ù„Ù‡Ø§ + 1 Ø¨Ø¹Ø¯Ù‡Ø§
  for (let i = 0; i < lines.length; i++) {
    const lower = lines[i].toLowerCase();
    if (keywords.some(k => lower.includes(k))) {
      for (let j = i - 5; j <= i + 1; j++) {
        if (j >= 0 && j < lines.length) linesToDelete.add(j);
      }
    }
  }

  // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø£Ø³Ø·Ø± Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
  let filtered = lines.filter((_, idx) => !linesToDelete.has(idx));

  // Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ Ø³Ø·Ø± ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ "Commentaire"
  filtered = filtered.filter(line => !line.includes('Commentaire'));

  // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ø§ Ø¨Ø¹Ø¯ Ø§Ù„Ù†Ù‚Ø·ØªÙŠÙ†
  const cleaned = filtered
    .map(getTextAfterColon)
    .map(line => line.trim() === '' ? '' : removeLeadingZero(line.trim()));

  // ØªÙˆØ²ÙŠØ¹ ÙƒÙ„ 6 Ø£Ø³Ø·Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø­Ù‚ÙˆÙ„
  const fields = [[], [], [], [], [], []];
  for (let i = 0; i < cleaned.length; i++) {
    const fieldIndex = i % 6;

    let line = cleaned[i];

    // ØªØ·Ø¨ÙŠÙ‚ Ù…Ø¹Ø§Ù…Ù„Ø© Ø®Ø§ØµØ© ÙÙ‚Ø· Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø§Ù†Ø© Ø§Ù„Ø®Ø§Ù…Ø³Ø© (index 4)
    if (fieldIndex === 4) {
      line = transformField5(line);
    }

    fields[fieldIndex].push(line);
  }

  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙˆØ§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª
  for (let i = 0; i < 6; i++) {
    const chunk = fields[i].join('\n') || '';
    document.getElementById('field' + (i + 1)).value = chunk;

    const count = chunk === '' ? 0 : fields[i].length;
    document.getElementById('count' + (i + 1)).textContent = count + ' Ø³Ø·Ø±';
  }
}

// Ø¯Ø§Ù„Ø© Ø®Ø§ØµØ© Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø®Ø§Ù†Ø© 5
function transformField5(str) {
  let modified = str.replace(/ï¿½/g, 'Ã©').trim();

  // Ø¥Ø°Ø§ ÙƒØ§Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ "|", Ù†Ø£Ø®Ø° Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø£Ø®ÙŠØ±
  if (modified.includes('|')) {
    const parts = modified.split('|');
    modified = parts[parts.length - 1].trim();
  }

  // Ø¥Ø°Ø§ ÙƒØ§Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ " -" ÙÙŠ Ø§Ù„Ù†Ù‡Ø§ÙŠØ©ØŒ Ù†Ø­Ø°ÙÙ‡
  if (modified.endsWith('-')) {
    modified = modified.slice(0, -1).trim();
  }

  return modified;
}

function removeDuplicatesBasedOnField1() {
  const numFields = 6;
  const fieldsData = [];
  for (let i = 1; i <= numFields; i++) {
    const value = document.getElementById('field' + i).value;
    fieldsData[i] = value.split('\n');
  }

  const maxRows = Math.max(...fieldsData.slice(1).map(arr => arr.length));

  const seen = new Set();
  const uniqueRows = [];

  for (let row = 0; row < maxRows; row++) {
    const field1Value = fieldsData[1][row] || "";

    if (!seen.has(field1Value)) {
      seen.add(field1Value);

      const rowData = [];
      for (let col = 1; col <= numFields; col++) {
        rowData.push(fieldsData[col][row] || "");
      }

      uniqueRows.push(rowData);
    }
  }

  const newFieldsData = Array.from({ length: numFields + 1 }, () => []);

  uniqueRows.forEach(rowArr => {
    for (let col = 1; col <= numFields; col++) {
      newFieldsData[col].push(rowArr[col - 1]);
    }
  });

  for (let i = 1; i <= numFields; i++) {
    const text = newFieldsData[i].join('\n');
    document.getElementById('field' + i).value = text;
    document.getElementById('count' + i).textContent = newFieldsData[i].length + ' Ø³Ø·Ø±';
  }
}


  function copyField(num) {
    const field = document.getElementById('field' + num);
    field.select();
    document.execCommand('copy');
  }

  // ØªØµØ¯ÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø®Ø§Ù†Ø§Øª Ø¥Ù„Ù‰ Ù…Ù„Ù Excel Ø¨ØªÙˆØ²ÙŠØ¹ Ø£Ø¹Ù…Ø¯Ø© Ù…Ø¹ÙŠÙ†
  function getFirstWord(text) {
  const word = (text || "").trim().split(/\s+/)[0];
  return word ? word : "CASABLANCA";
}


function exportToExcel() {
  const fieldsData = [];
  for (let i = 1; i <= 6; i++) {
    const value = document.getElementById('field' + i).value;
    fieldsData[i] = value.split('\n');
  }

  const maxRows = Math.max(...fieldsData.slice(1).map(arr => arr.length));

  const today = new Date();
  const formatDate = (date) => {
    const d = String(date.getDate()).padStart(2, '0');
    const m = String(date.getMonth() + 1).padStart(2, '0');
    const y = String(date.getFullYear());
    return `${d}/${m}/${y}`;
  };
const todayStr = getSelectedDate();

  const wsData = [];

  for (let row = 0; row < maxRows; row++) {
wsData[row] = [
  removeLeadingZero(fieldsData[1][row] || ""),  // A
  removeLeadingZero(fieldsData[4][row] || ""),  // B
  todayStr,                                     // C
  todayStr,                                     // D
  removeLeadingZero(fieldsData[5][row] || ""),  // E
  removeLeadingZero(fieldsData[6][row] || ""),  // F
  todayStr,                                     // G
  getFirstWord(fieldsData[6][row] || ""),       // âœ… H = Ø£ÙˆÙ„ ÙƒÙ„Ù…Ø© Ø£Ùˆ CASABLANCA
  removeLeadingZero(fieldsData[3][row] || ""),  // I
  removeLeadingZero(fieldsData[2][row] || "")   // J
];


  }

  const ws = XLSX.utils.aoa_to_sheet(wsData);

  // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ® (C, D, G)
  const dateColumns = [2, 3, 6]; // ÙÙ‡Ø§Ø±Ø³ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„ØªÙŠ ÙÙŠÙ‡Ø§ ØªÙˆØ§Ø±ÙŠØ® (C=2, D=3, G=6)
  for (let r = 0; r < maxRows; r++) {
    for (const col of dateColumns) {
      const cellRef = XLSX.utils.encode_cell({ c: col, r: r });
      if (!ws[cellRef]) continue;
      ws[cellRef].s = {
        alignment: {
          readingOrder: 2,      // RTL
          horizontal: "right"   // Ù…Ø­Ø§Ø°Ø§Ø© ÙŠÙ…ÙŠÙ†
        },
        numberFormat: "@",      // Ø¥Ø¬Ø¨Ø§Ø± ÙƒÙ†Øµ
      };
    }
  }

  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Sheet1");

  XLSX.writeFile(wb, "extracted_data.xlsx");
}
function copyExcelData() {
  const fieldsData = [];
  for (let i = 1; i <= 6; i++) {
    const value = document.getElementById('field' + i).value;
    fieldsData[i] = value.split('\n');
  }
  const maxRows = Math.max(...fieldsData.slice(1).map(arr => arr.length));

  // ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ… (ÙƒÙ…Ø§ ÙÙŠ Ø§Ù„ØªØµØ¯ÙŠØ±)
  const today = new Date();
  const formatDate = (date) => {
    const d = String(date.getDate()).padStart(2, '0');
    const m = String(date.getMonth() + 1).padStart(2, '0');
    const y = String(date.getFullYear());
    return `${d}/${m}/${y}`;
  };
const todayStr = getSelectedDate();

  // Ù†Ø¨Ù†ÙŠ Ø§Ù„Ù†Øµ Ø¨Ø´ÙƒÙ„ ØµÙÙˆÙ ÙˆØ£Ø¹Ù…Ø¯Ø© Ù…ÙØµÙˆÙ„Ø© Ø¨ØªØ§Ø¨ (tab)
  let textToCopy = "";
  for (let row = 0; row < maxRows; row++) {
    const rowData = [
      removeLeadingZero(fieldsData[1][row] || ""),  // A
      removeLeadingZero(fieldsData[4][row] || ""),  // B
      todayStr,                                     // C
      todayStr,                                     // D
      removeLeadingZero(fieldsData[5][row] || ""),  // E
      removeLeadingZero(fieldsData[6][row] || ""),  // F
      todayStr,                                     // G
      getFirstWord(fieldsData[6][row] || ""),       // H
      removeLeadingZero(fieldsData[3][row] || ""),  // I
      removeLeadingZero(fieldsData[2][row] || "")   // J
    ];
    textToCopy += rowData.join('\t') + '\n';
  }

  navigator.clipboard.writeText(textToCopy).catch(() => {
    alert('ØªÙ… Ù†Ø³Ø® Ù…Ø­ØªÙˆÙŠØ§Øª Ù…Ù„Ù Excel! ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ù„ØµÙ‚Ù‡Ø§ ÙÙŠ Ù…Ù„Ù Excel Ø¹Ù„Ù‰ SharePoint.');
  }).catch(() => {
    alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù†Ø³Ø®. Ø­Ø§ÙˆÙ„ Ù…Ø¬Ø¯Ø¯Ù‹Ø§.');
  });
}

function copyAllFields() {
  let combinedText = "";

  for (let i = 1; i <= 6; i++) {
    const textarea = document.getElementById('field' + i);
    const lines = textarea.value.trim();
    combinedText += `===== Ø®Ø§Ù†Ø© ${i} =====\n` + lines + '\n\n';
  }

  // Ø§Ø³ØªØ®Ø¯Ø§Ù… Clipboard API
  navigator.clipboard.writeText(combinedText).catch(() => {
  }).catch(() => {
  });
}
function getSelectedDate() {
  const radios = document.getElementsByName("dateOption");
  let selected = "today";

  for (const radio of radios) {
    if (radio.checked) {
      selected = radio.value;
      break;
    }
  }

  const today = new Date();
  const yesterday = new Date(today);
  yesterday.setDate(today.getDate() - 1);

  const formatDate = (date) => {
    const d = String(date.getDate()).padStart(2, '0');
    const m = String(date.getMonth() + 1).padStart(2, '0');
    const y = String(date.getFullYear());
    return `${d}/${m}/${y}`;
  };

  if (selected === "today") return formatDate(today);
  if (selected === "yesterday") return formatDate(yesterday);

  // Ù…Ø®ØµØµ
  const custom = document.getElementById("customDateInput").value;
  if (custom) {
    const parts = custom.split("-");
    if (parts.length === 3) {
      return `${parts[2]}/${parts[1]}/${parts[0]}`; // yyyy-mm-dd â†’ dd/mm/yyyy
    }
  }

  return formatDate(today); // fallback
}

</script>

</body>
</html>
