  // تعطيل الزر الأيمن
document.addEventListener("contextmenu", function(e) {
  e.preventDefault();
});

// تعطيل بعض اختصارات لوحة المفاتيح
document.addEventListener("keydown", function(e) {
  if (
    e.key === "F12" ||
    (e.ctrlKey && e.key.toLowerCase() === "u") ||    // Ctrl+U
    (e.ctrlKey && e.key.toLowerCase() === "s") ||    // Ctrl+S
    (e.ctrlKey && e.shiftKey && (e.key === "I" || e.key === "J")) // Ctrl+Shift+I/J
  ) {
    e.preventDefault();
    return false;
  }
});
  let originalMergedContent = "";

  // دمج ملفات TXT
function mergeFolderTxt() {
  const input = document.getElementById("folderInput");
  const files = input.files;

  if (!files.length) {
    alert("يرجى اختيار مجلد يحتوي على ملفات .txt.");
    return;
  }

  let mergedContent = "";
  let filesProcessed = 0;

  const txtFiles = Array.from(files).filter((file) =>
    file.name.toLowerCase().endsWith(".txt")
  );

  if (txtFiles.length === 0) {
    alert("لا يوجد ملفات .txt في هذا المجلد.");
    return;
  }

  txtFiles.sort((a, b) => a.name.localeCompare(b.name));

  txtFiles.forEach((file) => {
    const reader = new FileReader();
    reader.onload = function (e) {
      mergedContent += `\n===== ${file.name} =====\n` + e.target.result + "\n";
      filesProcessed++;
      if (filesProcessed === txtFiles.length) {
        originalMergedContent = mergedContent;
        document.getElementById("filteredOutput").value = mergedContent;

        // هنا استدعاء استخراج الكلمات بعد الدمج مباشرة
        extractSingleKeyword();
      }
    };
    reader.readAsText(file);
  });
}


  // نسخ النص الكامل (من الموقع الأول)
  function copyFiltered() {
    const textArea = document.getElementById("filteredOutput");
    textArea.select();
    document.execCommand("copy");
    window.getSelection().removeAllRanges();
  }

  // استخراج كلمات متعددة مفصولة بفاصلة (الموقع الأول)
  function extractSingleKeyword() {
    const keywordText = document.getElementById("singleKeywordInput").value.trim();
    const startOnly = document.getElementById("startOnlySingleCheckbox").checked;

    if (!keywordText) {
      alert("يرجى كتابة كلمة أو أكثر مفصولة بفاصلة للاستخراج.");
      return;
    }

    const keywords = keywordText.split(",").map(k => k.trim()).filter(k => k.length > 0);

    const lines = document.getElementById("filteredOutput").value.split("\n");
    const extractedLines = [];

    for (const line of lines) {
      const cleanLine = line.trim();
      for (const keyword of keywords) {
        if (
          (startOnly && cleanLine.startsWith(keyword)) ||
          (!startOnly && cleanLine.includes(keyword))
        ) {
          extractedLines.push(cleanLine);
          break;
        }
      }
    }

    document.getElementById("singleKeywordOutput").value = extractedLines.join("\n");

    // بعد الاستخراج يتم تنفيذ الفلترة والتوزيع تلقائياً
    filterAndDistribute();
  }

  // نسخ نتائج الاستخراج (الموقع الأول)
  function copySingleKeyword() {
    const textArea = document.getElementById("singleKeywordOutput");
    textArea.select();
    document.execCommand("copy");
    window.getSelection().removeAllRanges();
  }

  // --- الموقع الثاني: فلترة وتوزيع النصوص ---

  function getTextAfterColon(line) {
    const parts = line.split(':');
    return parts.length > 1 ? parts.slice(1).join(':').trim() : line.trim();
  }

  function removeLeadingZero(str) {
    if (/^0\d+$/.test(str)) { // يبدأ بـ0 ومتبوعة أرقام فقط
      return str.substring(1);
    }
    return str;
  }

function filterAndDistribute() {
  const text = document.getElementById('singleKeywordOutput').value;
  const keywordInput = document.getElementById('keyword').value.toLowerCase();
  const keywords = keywordInput.split('+').map(k => k.trim()).filter(k => k);
  const lines = text.split('\n');
  const linesToDelete = new Set();

  // حذف الأسطر التي تحتوي كلمات مفتاحية + 5 قبلها + 1 بعدها
  for (let i = 0; i < lines.length; i++) {
    const lower = lines[i].toLowerCase();
    if (keywords.some(k => lower.includes(k))) {
      for (let j = i - 5; j <= i + 1; j++) {
        if (j >= 0 && j < lines.length) linesToDelete.add(j);
      }
    }
  }

  // إزالة الأسطر المحددة
  let filtered = lines.filter((_, idx) => !linesToDelete.has(idx));

  // إزالة أي سطر يحتوي على "Commentaire"
  filtered = filtered.filter(line => !line.includes('Commentaire'));

  // استخراج ما بعد النقطتين
  const cleaned = filtered
    .map(getTextAfterColon)
    .map(line => line.trim() === '' ? '' : removeLeadingZero(line.trim()));

  // توزيع كل 6 أسطر على الحقول
  const fields = [[], [], [], [], [], []];
  for (let i = 0; i < cleaned.length; i++) {
    const fieldIndex = i % 6;

    let line = cleaned[i];

    // تطبيق معاملة خاصة فقط على الخانة الخامسة (index 4)
    if (fieldIndex === 4) {
      line = transformField5(line);
    }

    fields[fieldIndex].push(line);
  }

  // تحديث الحقول والعدادات
  for (let i = 0; i < 6; i++) {
    const chunk = fields[i].join('\n') || '';
    document.getElementById('field' + (i + 1)).value = chunk;

    const count = chunk === '' ? 0 : fields[i].length;
    document.getElementById('count' + (i + 1)).textContent = count + ' سطر';
  }
}

// دالة خاصة لمعالجة خانة 5
function transformField5(str) {
  let modified = str.replace(/�/g, 'é').trim();

  // إذا كان يحتوي على "|", نأخذ الجزء الأخير
  if (modified.includes('|')) {
    const parts = modified.split('|');
    modified = parts[parts.length - 1].trim();
  }

  // إذا كان يحتوي على " -" في النهاية، نحذفه
  if (modified.endsWith('-')) {
    modified = modified.slice(0, -1).trim();
  }

  return modified;
}

function removeDuplicatesBasedOnField1() {
  const numFields = 6;
  const fieldsData = [];
  for (let i = 1; i <= numFields; i++) {
    const value = document.getElementById('field' + i).value;
    fieldsData[i] = value.split('\n');
  }

  const maxRows = Math.max(...fieldsData.slice(1).map(arr => arr.length));

  const seen = new Set();
  const uniqueRows = [];

  for (let row = 0; row < maxRows; row++) {
    const field1Value = fieldsData[1][row] || "";

    if (!seen.has(field1Value)) {
      seen.add(field1Value);

      const rowData = [];
      for (let col = 1; col <= numFields; col++) {
        rowData.push(fieldsData[col][row] || "");
      }

      uniqueRows.push(rowData);
    }
  }

  const newFieldsData = Array.from({ length: numFields + 1 }, () => []);

  uniqueRows.forEach(rowArr => {
    for (let col = 1; col <= numFields; col++) {
      newFieldsData[col].push(rowArr[col - 1]);
    }
  });

  for (let i = 1; i <= numFields; i++) {
    const text = newFieldsData[i].join('\n');
    document.getElementById('field' + i).value = text;
    document.getElementById('count' + i).textContent = newFieldsData[i].length + ' سطر';
  }

  alert('تم حذف التكرار بناءً على خانة 1!');
}


  function copyField(num) {
    const field = document.getElementById('field' + num);
    field.select();
    document.execCommand('copy');
  }

  // تصدير بيانات الخانات إلى ملف Excel بتوزيع أعمدة معين
  function getFirstWord(text) {
  const word = (text || "").trim().split(/\s+/)[0];
  return word ? word : "CASABLANCA";
}


function exportToExcel() {
  const fieldsData = [];
  for (let i = 1; i <= 6; i++) {
    const value = document.getElementById('field' + i).value;
    fieldsData[i] = value.split('\n');
  }

  const maxRows = Math.max(...fieldsData.slice(1).map(arr => arr.length));

  const today = new Date();
  const formatDate = (date) => {
    const d = String(date.getDate()).padStart(2, '0');
    const m = String(date.getMonth() + 1).padStart(2, '0');
    const y = String(date.getFullYear());
    return `${d}/${m}/${y}`;
  };
const todayStr = getSelectedDate();

  const wsData = [];

  for (let row = 0; row < maxRows; row++) {
wsData[row] = [
  removeLeadingZero(fieldsData[1][row] || ""),  // A
  removeLeadingZero(fieldsData[4][row] || ""),  // B
  todayStr,                                     // C
  todayStr,                                     // D
  removeLeadingZero(fieldsData[5][row] || ""),  // E
  removeLeadingZero(fieldsData[6][row] || ""),  // F
  todayStr,                                     // G
  getFirstWord(fieldsData[6][row] || ""),       // ✅ H = أول كلمة أو CASABLANCA
  removeLeadingZero(fieldsData[3][row] || ""),  // I
  removeLeadingZero(fieldsData[2][row] || "")   // J
];


  }

  const ws = XLSX.utils.aoa_to_sheet(wsData);

  // تحديد التنسيق لحقول التاريخ (C, D, G)
  const dateColumns = [2, 3, 6]; // فهارس الأعمدة التي فيها تواريخ (C=2, D=3, G=6)
  for (let r = 0; r < maxRows; r++) {
    for (const col of dateColumns) {
      const cellRef = XLSX.utils.encode_cell({ c: col, r: r });
      if (!ws[cellRef]) continue;
      ws[cellRef].s = {
        alignment: {
          readingOrder: 2,      // RTL
          horizontal: "right"   // محاذاة يمين
        },
        numberFormat: "@",      // إجبار كنص
      };
    }
  }

  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Sheet1");

  XLSX.writeFile(wb, "extracted_data.xlsx");
}
function copyExcelData() {
  const fieldsData = [];
  for (let i = 1; i <= 6; i++) {
    const value = document.getElementById('field' + i).value;
    fieldsData[i] = value.split('\n');
  }
  const maxRows = Math.max(...fieldsData.slice(1).map(arr => arr.length));

  // تواريخ اليوم (كما في التصدير)
  const today = new Date();
  const formatDate = (date) => {
    const d = String(date.getDate()).padStart(2, '0');
    const m = String(date.getMonth() + 1).padStart(2, '0');
    const y = String(date.getFullYear());
    return `${d}/${m}/${y}`;
  };
const todayStr = getSelectedDate();

  // نبني النص بشكل صفوف وأعمدة مفصولة بتاب (tab)
  let textToCopy = "";
  for (let row = 0; row < maxRows; row++) {
    const rowData = [
      removeLeadingZero(fieldsData[1][row] || ""),  // A
      removeLeadingZero(fieldsData[4][row] || ""),  // B
      todayStr,                                     // C
      todayStr,                                     // D
      removeLeadingZero(fieldsData[5][row] || ""),  // E
      removeLeadingZero(fieldsData[6][row] || ""),  // F
      todayStr,                                     // G
      getFirstWord(fieldsData[6][row] || ""),       // H
      removeLeadingZero(fieldsData[3][row] || ""),  // I
      removeLeadingZero(fieldsData[2][row] || "")   // J
    ];
    textToCopy += rowData.join('\t') + '\n';
  }

  navigator.clipboard.writeText(textToCopy).then(() => {
    alert('تم نسخ محتويات ملف Excel! يمكنك الآن لصقها في ملف Excel على SharePoint.');
  }).catch(() => {
    alert('حدث خطأ أثناء النسخ. حاول مجددًا.');
  });
}

function copyAllFields() {
  let combinedText = "";

  for (let i = 1; i <= 6; i++) {
    const textarea = document.getElementById('field' + i);
    const lines = textarea.value.trim();
    combinedText += `===== خانة ${i} =====\n` + lines + '\n\n';
  }

  // استخدام Clipboard API
  navigator.clipboard.writeText(combinedText).then(() => {
    alert('✅ تم نسخ جميع الخانات بنجاح!');
  }).catch(() => {
    alert('❌ حدث خطأ أثناء النسخ، يرجى المحاولة مجددًا.');
  });
}
function getSelectedDate() {
  const radios = document.getElementsByName("dateOption");
  let selected = "today";

  for (const radio of radios) {
    if (radio.checked) {
      selected = radio.value;
      break;
    }
  }

  const today = new Date();
  const yesterday = new Date(today);
  yesterday.setDate(today.getDate() - 1);

  const formatDate = (date) => {
    const d = String(date.getDate()).padStart(2, '0');
    const m = String(date.getMonth() + 1).padStart(2, '0');
    const y = String(date.getFullYear());
    return `${d}/${m}/${y}`;
  };

  if (selected === "today") return formatDate(today);
  if (selected === "yesterday") return formatDate(yesterday);

  // مخصص
  const custom = document.getElementById("customDateInput").value;
  if (custom) {
    const parts = custom.split("-");
    if (parts.length === 3) {
      return `${parts[2]}/${parts[1]}/${parts[0]}`; // yyyy-mm-dd → dd/mm/yyyy
    }
  }

  return formatDate(today); // fallback
}
