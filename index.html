<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8" />
    <title>EXTRACTION CANVAS</title>
    <style>
        body {
            direction: rtl;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 10px;
            padding-top: 100px; /* ✅ هذه هي المساحة من الأعلى */
            display: flex;
            gap: 10px;
            height: 100vh;
            font-size: 13px;
            overflow: hidden; /* يمنع التمرير */
            box-sizing: border-box;
        }

        .container {
            flex: 1;
            max-width: 50%;
            display: flex;
            flex-direction: column;
            border: 1px solid #ccc;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 1px 1px 5px rgba(0,0,0,0.1);
            overflow: hidden;
        }
.header-logo {
    position: absolute;
    top: 10px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 1000;
    text-align: center;
}

.header-logo img {
    height: 60px; /* يمكنك تعديل الحجم حسب شعارك */
    object-fit: contain;
}

        h1, h2, h3 {
            font-size: 16px;
            margin-top: 0;
            text-align: center;
        }

        input[type="file"],
        input[type="text"],
        textarea {
            width: 100%;
            font-size: 12px;
            padding: 8px;
            margin-bottom: 8px;
            box-sizing: border-box;
            font-family: monospace;
            height: 60px;
            resize: none;
        }

        button {
            padding: 6px 10px;
            font-size: 13px;
            cursor: pointer;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            margin-bottom: 8px;
            transition: background-color 0.3s ease;
        }

            button:hover {
                background-color: #0056b3;
            }

        .copy-button {
            background-color: #28a745;
        }

            .copy-button:hover {
                background-color: #1e7e34;
            }

        .row {
            display: flex;
            gap: 6px;
            margin-bottom: 10px;
        }

        .field-container {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .line-count {
            font-weight: bold;
            font-size: 12px;
            color: #007bff;
            text-align: center;
            margin-bottom: 4px;
        }

        label {
            font-weight: bold;
            font-size: 12px;
            margin-bottom: 4px;
        }

            #keyword,
            label[for="keyword"] {
                display: none;
            }
    </style>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
</head>
<body>
<div class="header-logo">
    <img src="https://www.vernegroup.com/wp-content/uploads/2021/08/Image-1-1-1.png" alt="الشعار" />
</div>

    <div class="container" style="max-width: 45%;">
        <h1 style="text-align: center;">📁 EXTRACTION CANVAS 📁</h1>
        <input type="file" id="folderInput" webkitdirectory directory multiple accept=".txt,.html" />
        <button onclick="mergeFolderTxt()">دمج الملفات</button>

<textarea id="filteredOutput" rows="10" style="display:none;"></textarea>

        <h3>🔎 استخراج كلمات متعددة (مفصولة بفاصلة)</h3>
        <input type="text" id="singleKeywordInput" value="Envoy,Sent,ID CASE,Client :,T�l�phone,Acc�s r�seau,Activit�s de service,Téléphone,Accès réseau,Activités de service,Commentaire,Adresse Installation" />
        <label><input type="checkbox" id="startOnlySingleCheckbox" checked /> استخراج فقط الأسطر التي <strong>تبدأ</strong> بالكلمات</label><br />
        <button onclick="extractSingleKeyword()">🔎 استخراج</button>
<textarea id="singleKeywordOutput" rows="7" readonly placeholder="ستظهر هنا الأسطر التي تحتوي على الكلمات المختارة"></textarea>
        <button onclick="copySingleKeyword()" class="copy-button">📋 نسخ نتائج الاستخراج</button>
    </div>

    <div class="container" style="max-width: 50%;">
        <div class="row">
            <div class="field-container">
                <div class="line-count" id="count0">0 سطر</div>
                <textarea id="field0" readonly></textarea>
                <button class="copy-button" onclick="copyField(0)">📋 نسخ Envoyé</button>
            </div>
            <div class="field-container">
                <div class="line-count" id="count1">0 سطر</div>
                <textarea id="field1" readonly></textarea>
                <button class="copy-button" onclick="copyField(1)">📋 نسخ ID CASE</button>
            </div>
            <div class="field-container">
                <div class="line-count" id="count2">0 سطر</div>
                <textarea id="field2" readonly></textarea>
                <button class="copy-button" onclick="copyField(2)">📋 نسخ Client</button>
            </div>
        </div>

        <div class="row">
            <div class="field-container">
                <div class="line-count" id="count3">0 سطر</div>
                <textarea id="field3" readonly></textarea>
                <button class="copy-button" onclick="copyField(3)">📋 نسخ Téléphone</button>
            </div>
            <div class="field-container">
                <div class="line-count" id="count4">0 سطر</div>
                <textarea id="field4" readonly></textarea>
                <button class="copy-button" onclick="copyField(4)">📋 نسخ Accès réseau</button>
            </div>
            <div class="field-container">
                <div class="line-count" id="count5">0 سطر</div>
                <textarea id="field5" readonly></textarea>
                <button class="copy-button" onclick="copyField(5)">📋 نسخ Activités de service</button>
            </div>
        </div>

        <div class="row">
            <div class="field-container">
                <div class="line-count" id="count6">0 سطر</div>
                <textarea id="field6" readonly></textarea>
                <button class="copy-button" onclick="copyField(6)">📋 نسخ Adresse Installation</button>
            </div>
        </div>

<div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px;">
    <button onclick="removeDuplicatesAndAutoCopy()" style="background-color:#dc3545; color:white;">🧹 Remove & Copy ALL 🧹 </button>
    <button onclick="exportToExcel()" style="background-color:#ff6600; color:white;">⬇️ تصدير إلى Excel</button>
    <span id="countdown" style="font-weight: bold; color: red; font-size: 14px; margin-right: 10px;"></span>
</div>



        <script>
            document.addEventListener("contextmenu", e => e.preventDefault());
            document.addEventListener("keydown", e => {
                if (e.key === "F12" || (e.ctrlKey && ["u", "s"].includes(e.key.toLowerCase())) || (e.ctrlKey && e.shiftKey && ["I", "J"].includes(e.key))) { e.preventDefault(); return false; }
            });

            let originalMergedContent = "";


function mergeFolderTxt() {
    const files = Array.from(document.getElementById("folderInput").files).filter(f => f.name.toLowerCase().endsWith(".txt"));
    if (!files.length) {
        alert("يرجى اختيار مجلد يحتوي على ملفات .txt.");
        return;
    }

    files.sort((a, b) => a.name.localeCompare(b.name));
    let merged = "";
    let processed = 0;

    files.forEach(f => {
        const reader = new FileReader();
        reader.onload = e => {
            merged += `\n===== ${f.name} =====\n` + e.target.result + "\n";
            processed++;
            if (processed === files.length) {
                originalMergedContent = merged;
                document.getElementById("filteredOutput").value = merged;
                extractSingleKeyword();

                // ⏱️ عداد 3 ثواني
                let countdown = 0;
                const countdownEl = document.getElementById("countdown");
                if (countdownEl) countdownEl.textContent = `⬇️ سيتم النسخ التلقائي خلال ${countdown} ثواني...`;

                const timer = setInterval(() => {
                    countdown--;
                    if (countdown > 0) {
                        if (countdownEl) countdownEl.textContent = `⬇️ سيتم النسخ التلقائي خلال ${countdown} ثواني...`;
                    } else {
                        clearInterval(timer);
                        if (countdownEl) countdownEl.textContent = "";

                        // ✅ تنفيذ النسخ
                        removeDuplicatesAndAutoCopy();
// ✅ أول ضغطة بعد 0.001 ثانية
setTimeout(() => {
    const copyAllButton = Array.from(document.querySelectorAll('button'))
        .find(btn => btn.textContent.includes("🧹"));
    if (copyAllButton) copyAllButton.click();

    // ✅ بعد 15 ثانية من الضغطة الأولى → ابدأ المسار السريع
    setTimeout(() => {
        let fastPress = setInterval(() => {
            const copyAllButton = Array.from(document.querySelectorAll('button'))
                .find(btn => btn.textContent.includes("🧹"));
            if (copyAllButton) copyAllButton.click();
        }, 1); // 0.001 ثانية ≈ 1ms

        // ⏱️ توقف المسار السريع بعد دقيقة
        setTimeout(() => {
            clearInterval(fastPress);
        }, 60000);

    }, 15000); // بعد 15 ثانية من الضغطة الأولى

}, 1); // أول ضغطة بعد 0.001 ثانية

            }
        };
        reader.readAsText(f);
    });
}



            function extractSingleKeyword() {
                const keywordText = document.getElementById("singleKeywordInput").value.trim();
                const startOnly = document.getElementById("startOnlySingleCheckbox").checked;
                if (!keywordText) { alert("يرجى كتابة كلمة أو أكثر مفصولة بفاصلة للاستخراج."); return; }
                const keywords = keywordText.split(",").map(k => k.trim()).filter(k => k.length > 0);
                const lines = document.getElementById("filteredOutput").value.split("\n");
                const extracted = [];
                let buffer = [];
                let skip = false;
                for (const line of lines) {
                    const regexSkip = /sans\s+ca[\w\-]*/i; // يتحقق من وجود "sans" يليها كلمة تبدأ بـ ca
                    if (regexSkip.test(line)) {
                        buffer = [];
                        skip = true;
                        continue;
                    }
                    if (skip && line.includes("Adresse Installation")) { skip = false; continue; }
                    buffer.push(line);
                    if (keywords.some(k => line.startsWith(k))) {
                        extracted.push(...buffer);
                        buffer = [];
                    }
                }
                document.getElementById("singleKeywordOutput").value = extracted.join("\n");
                filterAndDistribute();
            }

            function copySingleKeyword() { const t = document.getElementById("singleKeywordOutput"); t.select(); document.execCommand("copy"); window.getSelection().removeAllRanges(); }

            function getTextAfterColon(line) {
                const parts = line.split(":");
                return parts.length > 1 ? parts.slice(1).join(":").trim() : line.trim();
            }

            function startsWithAny(line, keywords) {
                return keywords.find(keyword => line.toLowerCase().startsWith(keyword.toLowerCase()));
            }
            function filterAndDistribute() {
                const text = document.getElementById('singleKeywordOutput').value.split("\n");
                const fields = [[], [], [], [], [], [], []];
                let current = {};

                function cleanValue(line, keyword) {
                    let value = "";

                    if (line.includes(":")) {
                        value = line.split(":").slice(1).join(":").trim();
                    } else {
                        value = line.replace(new RegExp("^" + keyword, "i"), "").trim();
                    }

                    value = decodeCorruptedCharacters(value);
                    return value;
                }


                function decodeCorruptedCharacters(text) {
                    return text
                        .replace(/�/g, "é")
                        .replace(/Ã©/g, "é")
                        .replace(/Ã¨/g, "è")
                        .replace(/Ã/g, "à")
                        .replace(/Ã´/g, "ô")
                        .replace(/Ãª/g, "ê")
                        .replace(/Ã¢/g, "â")
                        .replace(/Ã¼/g, "ü")
                        .replace(/Ã§/g, "ç")
                        .replace(/Â/g, "")
                        .replace(/[^\x00-\x7F]/g, c => c);
                }

                function normalizePhone(phone) {
                    return phone.startsWith("0") ? phone.substring(1) : phone;
                }

                // ✅ دالة جديدة تتحقق من أن الكلمة في أول السطر ومتبوعة بـ :
                function startsWithAnyStrict(line, keywords) {
                    line = line.trimStart(); // إزالة الفراغات من بداية السطر
                    for (let keyword of keywords) {
                        const regex = new RegExp("^" + keyword.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&') + "\\s*:", "i");
                        if (regex.test(line)) return keyword;
                    }
                    return null;
                }


                for (let i = 0; i < text.length; i++) {
                    const line = text[i].trim();

                    // الحقل 0 - Envoyé أو Sent
                    const envoyKey = startsWithAnyStrict(line, ["Envoyé", "Envoy�", "Sent"]);
                    if (envoyKey) {
                        current[0] = cleanValue(line, envoyKey);
                    }

                    // الحقل 1 - ID CASE
                    else if (startsWithAnyStrict(line, ["ID CASE"])) {
                        current[1] = cleanValue(line, "ID CASE");
                    }

                    // الحقل 2 - Client
                    else if (startsWithAnyStrict(line, ["Client"])) {
                        current[2] = cleanValue(line, "Client");
                    }

                    // الحقل 3 - Téléphone
                    const telKey = startsWithAnyStrict(line, ["T�l�phone", "Téléphone"]);
                    if (telKey) {
                        current[3] = normalizePhone(cleanValue(line, telKey));
                    }

                    // الحقل 4 - Accès réseau
                    const reseauKey = startsWithAnyStrict(line, ["Acc�s r�seau", "Accès réseau"]);
                    if (reseauKey) {
                        current[4] = normalizePhone(cleanValue(line, reseauKey));
                    }

                    // الحقل 5 - Activités de service
                    const activitesKey = startsWithAnyStrict(line, ["Activit�s de service", "Activités de service"]);
                    if (activitesKey) {
                        let rawValue = cleanValue(line, activitesKey);
                        let parts = rawValue.split("|");
                        let lastPart = parts.length > 1 ? parts[parts.length - 1].trim() : rawValue.trim();
                        lastPart = lastPart.replace(/[^\w\s\u00C0-\u017F]/g, '').trim();
                        current[5] = lastPart;
                    }

                    // الحقل 6 - Adresse Installation ← السطر الذي يعتبر نهاية السجل
                    else if (startsWithAnyStrict(line, ["Adresse Installation"])) {
                        current[6] = cleanValue(line, "Adresse Installation");

                        // نسجّل السطر الحالي في الأعمدة السبعة
                        for (let j = 0; j <= 6; j++) {
                            fields[j].push(current[j] || "");
                        }
                        current = {}; // إعادة تعيين السجل
                    }
                }

                // عرض النتائج في الواجهة
                for (let i = 0; i <= 6; i++) {
                    document.getElementById("field" + i).value = fields[i].join("\n");
                    document.getElementById("count" + i).textContent = fields[i].length + " سطر";
                }
            }

            function removeDuplicatesAndAutoCopy() {
                removeDuplicatesBasedOnField1();

                // إنشاء زر مخفي مؤقتاً لتنفيذ النسخ بعد 2 ثانية
                setTimeout(() => {
                    // إنشاء عنصر textarea مؤقت
                    const tempTextarea = document.createElement("textarea");
                    tempTextarea.style.position = "fixed";
                    tempTextarea.style.opacity = "0";
                    tempTextarea.value = generateExcelText(); // ننسخ نفس النص الذي يستخدم في copyExcelData()
                    document.body.appendChild(tempTextarea);
                    tempTextarea.select();

                    try {
                        const successful = document.execCommand('copy');
                        // النسخ تم بنجاح أو فشل
                        console.log(successful ? "تم النسخ بنجاح" : "فشل النسخ");
                    } catch (err) {
                        console.error("خطأ في النسخ:", err);
                    }

                    document.body.removeChild(tempTextarea);
                }, 2000);
            }

            function generateExcelText() {
                const fieldsData = [], numFields = 7;
                for (let i = 0; i < numFields; i++) {
                    fieldsData[i] = document.getElementById("field" + i).value.split("\n");
                }
                const maxRows = Math.max(...fieldsData.map(arr => arr.length));
                let text = "";

                for (let r = 0; r < maxRows; r++) {
                    const rawDate = fieldsData[0][r] || "";
                    const parsedDate = parseFrenchDateToDDMMYYYY(rawDate);

                    const firstWord = (fieldsData[6][r] || "").trim().split(/\s+/)[0] || "CASABLANCA";

                    const rowData = [
                        fieldsData[1][r] || "",  // A: ID CASE
                        fieldsData[4][r] || "",  // B: Accès réseau
                        parsedDate || "",        // C
                        parsedDate || "",        // D
                        fieldsData[5][r] || "",  // E
                        fieldsData[6][r] || "",  // F
                        parsedDate || "",        // G
                        firstWord,               // H
                        fieldsData[3][r] || "",  // I
                        fieldsData[2][r] || "",  // J
                        "", "", parsedDate || "" // K, L, N
                    ];

                    text += rowData.join("\t") + "\n";
                }

                return text;
            }


// في main.js أو script داخل HTML
const worker = new Worker('worker.js');

worker.onmessage = function(e) {
    const uniqueText = e.data;
    console.log("النتيجة بدون تكرار:", uniqueText);
};

worker.postMessage(document.getElementById("someTextarea").value);



            function removeDuplicatesBasedOnField1() {
                const numFields = 7, fieldsData = [];
                for (let i = 0; i < numFields; i++) fieldsData[i] = document.getElementById("field" + i).value.split("\n");
                const maxRows = Math.max(...fieldsData.map(arr => arr.length));
                const seen = new Set(), uniqueRows = [];
                for (let r = 0; r < maxRows; r++) {
                    const v = fieldsData[1][r] || "";
                    if (!seen.has(v)) { seen.add(v); const row = []; for (let c = 0; c < numFields; c++) row.push(fieldsData[c][r] || ""); uniqueRows.push(row); }
                }
                const newFields = Array.from({ length: numFields }, () => []);
                uniqueRows.forEach(row => { for (let c = 0; c < numFields; c++) newFields[c].push(row[c]); });
                for (let i = 0; i < numFields; i++) { document.getElementById("field" + i).value = newFields[i].join("\n"); document.getElementById("count" + i).textContent = newFields[i].length + " سطر"; }
            }

            function copyField(n) { const f = document.getElementById("field" + n); f.select(); document.execCommand("copy"); }

            function getSelectedDate() { return new Date().toLocaleDateString("fr-FR"); }

            function getFirstWord(text) { const w = (text || "").trim().split(/\s+/)[0]; return w ? w : "CASABLANCA"; }

            function parseFrenchDateToDDMMYYYY(str) {
                const months = {
                    janvier: "01", février: "02", fevrier: "02", mars: "03", avril: "04", mai: "05",
                    juin: "06", juillet: "07", aoét: "08", aout: "08", septembre: "09",
                    octobre: "10", novembre: "11", décembre: "12", decembre: "12"
                };

                // إزالة اسم اليوم والوقت (المحتوى بعد الوقت)
                const dateString = str.replace(/^(?:\w+\s+)+(\d{1,2})\s+([a-zéû]+)\s+(\d{4})\s+\d{1,2}:\d{2}$/, '$1 $2 $3');

                const match = dateString.match(/(\d{1,2})\s+([a-zéû]+)\s+(\d{4})/i);

                if (match) {
                    const day = match[1].padStart(2, "0");
                    const month = months[match[2].toLowerCase()] || "01";
                    const year = match[3];

                    return `${day}/${month}/${year}`;
                }

                return ""; // فارغ إذا لم يتطابق
            }


            function exportToExcel() {
                const fieldsData = [], numFields = 7;
                for (let i = 0; i < numFields; i++) {
                    fieldsData[i] = document.getElementById("field" + i).value.split("\n");
                }
                const maxRows = Math.max(...fieldsData.map(arr => arr.length));
                const wsData = [];

                for (let r = 0; r < maxRows; r++) {
                    const rawDateLine = fieldsData[0][r] || "";  // الحصول على التاريخ
                    const parsedDate = parseFrenchDateToDDMMYYYY(rawDateLine);

                    // وضع التاريخ المحول فقط في الأعمدة C, D, G, N
                    wsData[r] = [
                        fieldsData[1][r] || "",  // A: ID CASE
                        fieldsData[4][r] || "",  // B: Accès réseau
                        parsedDate || "",        // C: Envoyé
                        parsedDate || "",        // D: Envoyé (مكرر)
                        fieldsData[5][r] || "",  // E: Activités de service
                        fieldsData[6][r] || "",  // F: Adresse Installation
                        parsedDate || "",        // G: Envoyé (مكرر)
                        (fieldsData[6][r] || "").trim().split(/\s+/)[0] || "CASABLANCA", // H: الكلمة الأولى من Adresse Installation أو CASABLANCA
                        fieldsData[3][r] || "",  // I: Téléphone
                        fieldsData[2][r] || "",  // J: Client
                        "",                      // K: فراغ
                        "",                      // L: فراغ
                        parsedDate || ""         // N: التاريخ بصيغة DD/MM/YYYY
                    ];
                }

                const ws = XLSX.utils.aoa_to_sheet(wsData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
                XLSX.writeFile(wb, "extracted_data.xlsx");
            }


            function copyExcelData() {
                const fieldsData = [], numFields = 7;
                for (let i = 0; i < numFields; i++) {
                    fieldsData[i] = document.getElementById("field" + i).value.split("\n");
                }
                const maxRows = Math.max(...fieldsData.map(arr => arr.length));
                let text = "";

                for (let r = 0; r < maxRows; r++) {
                    const rawDate = fieldsData[0][r] || "";
                    const parsedDate = parseFrenchDateToDDMMYYYY(rawDate);

                    const firstWord = (fieldsData[6][r] || "").trim().split(/\s+/)[0] || "CASABLANCA";

                    const rowData = [
                        fieldsData[1][r] || "",  // A: ID CASE
                        fieldsData[4][r] || "",  // B: Accès réseau
                        parsedDate || "",        // C: Envoyé (التاريخ المحول في العمود C)
                        parsedDate || "",        // D: Envoyé (التاريخ المحول في العمود D)
                        fieldsData[5][r] || "",  // E: Activités de service
                        fieldsData[6][r] || "",  // F: Adresse Installation
                        parsedDate || "",        // G: Envoyé (التاريخ المحول في العمود G)
                        firstWord,               // H: الكلمة الأولى أو CASABLANCA
                        fieldsData[3][r] || "",  // I: Téléphone
                        fieldsData[2][r] || "",  // J: Client
                        "",                      // K: فراغ
                        "",                      // L: فراغ
                        parsedDate || ""         // N: التاريخ بصيغة DD/MM/YYYY
                    ];

                    text += rowData.join("\t") + "\n";
                }

                // نسخ المحتويات إلى الحافظة بدون رسائل تنبيه
                navigator.clipboard.writeText(text)
                    .catch(() => { }); // تجاهل أي أخطاء بدون إظهار رسائل
            }



        </script>
</body>
</html>



