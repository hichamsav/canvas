<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8" />
    <title>EXTRACTION CANVAS</title>
    <style>
        body {
            direction: rtl;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 10px;
            padding-top: 100px;
            display: flex;
            gap: 10px;
            height: 100vh;
            font-size: 13px;
            overflow: hidden;
            box-sizing: border-box;
        }

        .container {
            flex: 1;
            max-width: 50%;
            display: flex;
            flex-direction: column;
            border: 1px solid #ccc;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 1px 1px 5px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header-logo {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            text-align: center;
        }

        .header-logo img {
            height: 60px;
            object-fit: contain;
        }

        h1, h2, h3 {
            font-size: 16px;
            margin-top: 0;
            text-align: center;
        }

        input[type="file"],
        input[type="text"],
        textarea {
            width: 100%;
            font-size: 12px;
            padding: 8px;
            margin-bottom: 8px;
            box-sizing: border-box;
            font-family: monospace;
            height: 60px;
            resize: none;
        }

        button {
            padding: 6px 10px;
            font-size: 13px;
            cursor: pointer;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            margin-bottom: 8px;
            transition: background-color 0.3s ease;
        }

        button:hover {
            background-color: #0056b3;
        }

        .copy-button {
            background-color: #28a745;
        }

        .copy-button:hover {
            background-color: #1e7e34;
        }

        .row {
            display: flex;
            gap: 6px;
            margin-bottom: 10px;
        }

        .field-container {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .line-count {
            font-weight: bold;
            font-size: 12px;
            color: #007bff;
            text-align: center;
            margin-bottom: 4px;
        }

        label {
            font-weight: bold;
            font-size: 12px;
            margin-bottom: 4px;
        }

        #keyword,
        label[for="keyword"] {
            display: none;
        }

        /* زر الصفحة الرئيسية في الأسفل */
        .bottom-home-btn {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            z-index: 1000;
            text-decoration: none;
        }

        .bottom-home-btn:hover {
            background: #218838;
        }
    </style>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
</head>
<body>
    <div class="header-logo">
        <img src="https://www.vernegroup.com/wp-content/uploads/2021/08/Image-1-1-1.png" alt="الشعار" />
    </div>
    
    <div class="container" style="max-width: 45%;">
        <h1 style="text-align: center;">📁 EXTRACTION CANVAS 📁</h1>
        <input type="file" id="folderInput" webkitdirectory directory multiple accept=".txt,.html" />
        <button onclick="mergeFolderTxt()">دمج الملفات</button>

        <textarea id="filteredOutput" rows="10" style="display:none;"></textarea>

        <h3>🔎 استخراج كلمات متعددة (مفصولة بفاصلة)</h3>
        <input type="text" id="singleKeywordInput" value="Reçu le,Envoyé,Sent,Date,ID CASE,Client :,Téléphone,Accès réseau,Activités de service,Commentaire,Adresse Installation" />
        <label><input type="checkbox" id="startOnlySingleCheckbox" checked /> استخراج فقط الأسطر التي <strong>تبدأ</strong> بالكلمات</label><br />
        <button onclick="extractSingleKeyword()">🔎 استخراج</button>
        <textarea id="singleKeywordOutput" rows="7" readonly placeholder="ستظهر هنا الأسطر التي تحتوي على الكلمات المختارة"></textarea>
        <button onclick="copySingleKeyword()" class="copy-button">📋 نسخ نتائج الاستخراج</button>
    </div>

    <div class="container" style="max-width: 50%;">
        <div class="row">
            <div class="field-container">
                <div class="line-count" id="count0">0 سطر</div>
                <textarea id="field0" readonly></textarea>
                <button class="copy-button" onclick="copyField(0)">📋 نسخ Envoyé</button>
            </div>
            <div class="field-container">
                <div class="line-count" id="count1">0 سطر</div>
                <textarea id="field1" readonly></textarea>
                <button class="copy-button" onclick="copyField(1)">📋 نسخ ID CASE</button>
            </div>
            <div class="field-container">
                <div class="line-count" id="count2">0 سطر</div>
                <textarea id="field2" readonly></textarea>
                <button class="copy-button" onclick="copyField(2)">📋 نسخ Client</button>
            </div>
        </div>

        <div class="row">
            <div class="field-container">
                <div class="line-count" id="count3">0 سطر</div>
                <textarea id="field3" readonly></textarea>
                <button class="copy-button" onclick="copyField(3)">📋 نسخ Téléphone</button>
            </div>
            <div class="field-container">
                <div class="line-count" id="count4">0 سطر</div>
                <textarea id="field4" readonly></textarea>
                <button class="copy-button" onclick="copyField(4)">📋 نسخ Accès réseau</button>
            </div>
            <div class="field-container">
                <div class="line-count" id="count5">0 سطر</div>
                <textarea id="field5" readonly></textarea>
                <button class="copy-button" onclick="copyField(5)">📋 نسخ Activités de service</button>
            </div>
        </div>

        <div class="row">
            <div class="field-container">
                <div class="line-count" id="count6">0 سطر</div>
                <textarea id="field6" readonly></textarea>
                <button class="copy-button" onclick="copyField(6)">📋 نسخ Adresse Installation</button>
            </div>
            <div class="field-container">
                <div class="line-count" id="count7">0 سطر</div>
                <textarea id="field7" readonly></textarea>
                <button class="copy-button" onclick="copyField(7)">📋 نسخ Commentaire</button>
            </div>
        </div>

        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px;">
            <button onclick="removeDuplicatesBasedOnReseauSmart(); copyExcelData();" style="background-color:#dc3545; color:white;">🧹 Remove & Copy ALL 🧹 </button>
            <button onclick="exportToExcel()" style="background-color:#ff6600; color:white;">⬇️ تصدير إلى Excel</button>
            <span id="countdown" style="font-weight: bold; color: red; font-size: 14px; margin-right: 10px;"></span>
        </div>
    </div>

    <!-- زر الصفحة الرئيسية في الأسفل -->
    <button class="bottom-home-btn" onclick="goToHome()">🏠 الصفحة الرئيسية</button>

    <script>
        // ========== الحمايات فقط ==========
        
        // دالة العودة للصفحة الرئيسية
        function goToHome() {
            window.location.href = 'index.html';
        }

        // منع النقر الأيمن
        document.addEventListener('contextmenu', function(e) {
            e.preventDefault();
            return false;
        });

        // منع فتح أدوات المطورين
        document.addEventListener('keydown', function(e) {
            if (e.key === 'F12' || 
                (e.ctrlKey && e.shiftKey && e.key === 'I') ||
                (e.ctrlKey && e.shiftKey && e.key === 'J') ||
                (e.ctrlKey && e.shiftKey && e.key === 'C') ||
                (e.ctrlKey && e.key === 'u')) {
                e.preventDefault();
                return false;
            }
        });

        // ========== نهاية الحمايات ==========

        // ========== الكود الأصلي بدون أي تغيير ==========
        window.alert = function() {};
        const originalAlert = window.alert;

        window.alert = function(message) {
            if (typeof message === 'string' && message.includes('hichamsav.github.io')) {
                return;
            }
            originalAlert(message);
        };

        document.addEventListener("contextmenu", e => e.preventDefault());
        document.addEventListener("keydown", e => {
            if (e.key === "F12" || (e.ctrlKey && ["u", "s"].includes(e.key.toLowerCase())) || (e.ctrlKey && e.shiftKey && ["I", "J"].includes(e.key))) { 
                e.preventDefault(); 
                return false; 
            }
        });

        let originalMergedContent = "";

        function mergeFolderTxt() {
            const files = Array.from(document.getElementById("folderInput").files).filter(f => f.name.toLowerCase().endsWith(".txt"));
            if (!files.length) {
                alert("يرجى اختيار مجلد يحتوي على ملفات .txt.");
                return;
            }

            files.sort((a, b) => a.name.localeCompare(b.name));
            let merged = "";
            let processed = 0;

            files.forEach(f => {
                const reader = new FileReader();
                reader.onload = e => {
                    merged += `\n===== ${f.name} =====\n` + e.target.result + "\n";
                    processed++;
                    if (processed === files.length) {
                        originalMergedContent = merged;
                        document.getElementById("filteredOutput").value = merged;
                        extractSingleKeyword();
                    }
                };
                reader.readAsText(f);
            });
        }

        function extractSingleKeyword() {
            const lines = document.getElementById("filteredOutput").value.split("\n");
            const extracted = [];
            
            let inTargetBlock = false;
            let currentBlock = [];
            let blocksFound = 0;

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                
                // بداية الكتلة عندما نجد "Date:"
                if (line.startsWith("Date:")) {
                    if (currentBlock.length > 0) {
                        extracted.push(...currentBlock);
                        extracted.push(""); // فاصل بين الكتل
                        blocksFound++;
                    }
                    currentBlock = [line];
                    inTargetBlock = true;
                    continue;
                }
                
                // نهاية الكتلة عندما نجد "Adresse Installation"
                if (inTargetBlock && line.includes("Adresse Installation :")) {
                    currentBlock.push(line);
                    extracted.push(...currentBlock);
                    extracted.push(""); // فاصل بين الكتل
                    blocksFound++;
                    currentBlock = [];
                    inTargetBlock = false;
                    continue;
                }
                
                // إذا كنا داخل الكتلة المستهدفة، نضيف السطر
                if (inTargetBlock && line) {
                    currentBlock.push(line);
                }
            }
            
            // إضافة آخر كتلة إذا كانت غير مكتملة
            if (currentBlock.length > 0) {
                extracted.push(...currentBlock);
                blocksFound++;
            }

            document.getElementById("singleKeywordOutput").value = extracted.join("\n");
            console.log("تم استخراج " + blocksFound + " كتلة بيانات");
            filterAndDistribute();
        }

        function copySingleKeyword() { 
            const t = document.getElementById("singleKeywordOutput"); 
            t.select(); 
            document.execCommand("copy"); 
            window.getSelection().removeAllRanges(); 
        }

        function decodeCorruptedCharacters(text) {
            return text
                .replace(/�/g, "é")
                .replace(/Ã©/g, "é")
                .replace(/Ã¨/g, "è")
                .replace(/Ã/g, "à")
                .replace(/Ã´/g, "ô")
                .replace(/Ãª/g, "ê")
                .replace(/Ã¢/g, "â")
                .replace(/Ã¼/g, "ü")
                .replace(/Ã§/g, "ç")
                .replace(/Â/g, "");
        }

        function normalizePhone(phone) {
            return phone.startsWith("0") ? phone.substring(1) : phone;
        }

        function extractDateFromSent(sentLine) {
            // استخراج التاريخ من سطر Date: 09/26/2025 18:13:01
            const match = sentLine.match(/Date:\s*(\d{2}\/\d{2}\/\d{4})/);
            return match ? match[1] : "";
        }

        function filterAndDistribute() {
            const text = document.getElementById('singleKeywordOutput').value.split("\n");
            const fields = Array.from({ length: 8 }, () => []);
            let current = {};
            let currentAdresse = "";
            let currentVille = "";
            let currentDate = "";
            let commentaireContent = "";
            
            for (let i = 0; i < text.length; i++) {
                const line = text[i].trim();
                
                if (!line) continue;
                
                // ⬇️ بداية رسالة جديدة - إعادة تعيين كل شيء
                if (line.match(/^Date:/i)) {
                    // حفظ السجل السابق إذا كان موجوداً
                    if (Object.keys(current).length > 0) {
                        for (let j = 0; j <= 7; j++) {
                            fields[j].push(current[j] || "");
                        }
                    }
                    
                    // إعادة تعيين كل المتغيرات لرسالة جديدة
                    current = {};
                    currentDate = extractDateFromSent(line);
                    current[0] = line.replace(/^Date:\s*/i, "").trim();
                    currentAdresse = "";
                    currentVille = "";
                    commentaireContent = "";
                }
                else if (line.match(/^ID CASE\s*:/i)) {
                    current[1] = line.replace(/^ID CASE\s*:\s*/i, "").trim();
                }
                else if (line.match(/^Client\s*:/i)) {
                    current[2] = line.replace(/^Client\s*:\s*/i, "").trim();
                }
                else if (line.match(/^Téléphone\s*:/i) || line.match(/^T�l�phone\s*:/i)) {
                    let phoneValue = line.replace(/^Téléphone\s*:\s*/i, "").replace(/^T�l�phone\s*:\s*/i, "").trim();
                    current[3] = normalizePhone(phoneValue);
                }
                else if (line.match(/^Accès réseau\s*:/i) || line.match(/^Acc�s r�seau\s*:/i)) {
                    let reseauValue = line.replace(/^Accès réseau\s*:\s*/i, "").replace(/^Acc�s r�seau\s*:\s*/i, "").trim();
                    current[4] = normalizePhone(reseauValue);
                }
                else if (line.match(/^Activités de service\s*:/i) || line.match(/^Activit�s de service\s*:/i)) {
                    let rawValue = line.replace(/^Activités de service\s*:\s*/i, "").replace(/^Activit�s de service\s*:\s*/i, "").trim();
                    let parts = rawValue.split("|");
                    let lastPart = parts.length > 1 ? parts[parts.length - 1].trim() : rawValue.trim();
                    current[5] = lastPart.replace(/[^\w\s\u00C0-\u017F]/g, '').trim();
                }
                else if (line.match(/^Commentaire\s*:/i)) {
                    // ⬇️ Commentaire للرسالة الحالية فقط
                    commentaireContent = line.replace(/^Commentaire\s*:\s*/i, "").trim();
                    current[7] = commentaireContent;
                    
                    // البحث عن Adresse
                    if (commentaireContent.includes("Adresse :") || commentaireContent.includes("adresse :")) {
                        let adresseMatch = commentaireContent.match(/Adresse\s*:\s*(.+)/i) || commentaireContent.match(/adresse\s*:\s*(.+)/i);
                        if (adresseMatch) {
                            currentAdresse = adresseMatch[1].trim();
                        }
                    }
                }
                // ⬇️ البحث عن Adresse في أي سطر
                else if (line.includes("Adresse :") || line.includes("adresse :")) {
                    let adresseMatch = line.match(/Adresse\s*:\s*(.+)/i) || line.match(/adresse\s*:\s*(.+)/i);
                    if (adresseMatch) {
                        currentAdresse = adresseMatch[1].trim();
                    }
                }
                else if (line.match(/^Adresse Installation\s*:/i)) {
                    let adresseValue = line.replace(/^Adresse Installation\s*:\s*/i, "").trim();
                    
                    // ⬇️ إذا كان Adresse Installation فارغاً
                    if (!adresseValue || adresseValue === "") {
                        if (currentAdresse) {
                            adresseValue = currentAdresse;
                        } else if (currentVille) {
                            adresseValue = currentVille;
                        }
                    }
                    
                    current[6] = adresseValue || "";
                    current.date = currentDate;
                    current[7] = commentaireContent; // ⬇️ تأكيد حفظ Commentaire الحالي فقط
                    
                    // حفظ السجل
                    for (let j = 0; j <= 7; j++) {
                        fields[j].push(current[j] || "");
                    }
                    
                    // ⬇️ إعادة تعيين للمرسالة التالية
                    current = {};
                    currentAdresse = "";
                    currentVille = "";
                    currentDate = "";
                    commentaireContent = "";
                }
            }

            // معالجة أي سجل متبقي
            if (Object.keys(current).length > 0) {
                for (let j = 0; j <= 7; j++) {
                    fields[j].push(current[j] || "");
                }
            }

            for (let i = 0; i <= 7; i++) {
                let fieldValue = fields[i].join("\n");
                fieldValue = decodeCorruptedCharacters(fieldValue);
                document.getElementById("field" + i).value = fieldValue;
                document.getElementById("count" + i).textContent = fields[i].length + " سطر";
            }
        }

        function removeDuplicatesBasedOnReseauSmart() {
            const numFields = 8;
            const fieldsData = [];
            for (let i = 0; i < numFields; i++) {
                fieldsData[i] = document.getElementById("field" + i).value.split("\n");
            }

            const grouped = new Map();
            const maxRows = Math.max(...fieldsData.map(arr => arr.length));

            for (let r = 0; r < maxRows; r++) {
                const reseau = fieldsData[4][r] || "";
                const record = [];

                for (let c = 0; c < numFields; c++) {
                    record.push(fieldsData[c][r] || "");
                }

                if (!reseau) continue;

                if (!grouped.has(reseau)) {
                    grouped.set(reseau, []);
                }

                grouped.get(reseau).push(record);
            }

            const selectedRecords = [];

            for (const [reseau, records] of grouped.entries()) {
                // اختيار السجل الأكثر اكتمالاً (الذي يحتوي على Commentaire أو Adresse Installation)
                let best = records[0];

                for (const rec of records) {
                    const hasComment = rec[7] && rec[7].trim().length > 0;
                    const hasAdresse = rec[6] && rec[6].trim().length > 0;

                    const bestHasComment = best[7] && best[7].trim().length > 0;
                    const bestHasAdresse = best[6] && best[6].trim().length > 0;

                    if ((hasComment && !bestHasComment) || (hasAdresse && !bestHasAdresse)) {
                        best = rec;
                    }
                }

                // تعويض Adresse Installation إذا كانت فارغة
                if (!best[6] || best[6].trim() === "") {
                    const commentaire = best[7] || "";
                    const adresseMatch = commentaire.match(/Adresse\s*:\s*(.+)/i);
                    const villeMatch = commentaire.match(/Ville\s*:\s*(.+)/i);

                    if (adresseMatch) best[6] = adresseMatch[1].trim();
                    else if (villeMatch) best[6] = villeMatch[1].trim();
                }

                selectedRecords.push(best);
            }

            // تفريغ البيانات المختارة في الحقول
            for (let i = 0; i < numFields; i++) {
                const columnData = selectedRecords.map(rec => decodeCorruptedCharacters(rec[i] || ""));
                document.getElementById("field" + i).value = columnData.join("\n");
                document.getElementById("count" + i).textContent = columnData.length + " سطر";
            }
        }

        function parseFrenchDateToDDMMYYYY(str) {
            const months = {
                janvier: "01", février: "02", fevrier: "02", mars: "03", avril: "04", mai: "05",
                juin: "06", juillet: "07", août: "08", aout: "08", septembre: "09",
                octobre: "10", novembre: "11", décembre: "12", decembre: "12"
            };

            const regex = /(\d{1,2})\s+([a-zéû]+)\s+(\d{4})(?:\s+(\d{1,2}):(\d{2})(?::(\d{2}))?)?/i;
            const match = str.match(regex);

            if (match) {
                const day = match[1].padStart(2, "0");
                const month = months[match[2].toLowerCase()] || "01";
                const year = match[3];
                const hour = match[4] ? match[4].padStart(2, "0") : "00";
                const minute = match[5] ? match[5].padStart(2, "0") : "00";
                const second = match[6] ? match[6].padStart(2, "0") : "00";

                return {
                    full: `${day}/${month}/${year} ${hour}:${minute}:${second}`,
                    short: `${day}/${month}/${year}`
                };
            }

            const parsed = new Date(str);
            if (!isNaN(parsed)) {
                const day = String(parsed.getDate()).padStart(2, "0");
                const month = String(parsed.getMonth() + 1).padStart(2, "0");
                const year = parsed.getFullYear();
                const hour = String(parsed.getHours()).padStart(2, "0");
                const minute = String(parsed.getMinutes()).padStart(2, "0");
                const second = String(parsed.getSeconds()).padStart(2, "0");

                return {
                    full: `${day}/${month}/${year} ${hour}:${minute}:${second}`,
                    short: `${day}/${month}/${year}`
                };
            }

            return { full: "", short: "" };
        }

        function exportToExcel() {
            const fieldsData = [], numFields = 8;
            for (let i = 0; i < numFields; i++) {
                fieldsData[i] = document.getElementById("field" + i).value.split("\n");
            }

            const maxRows = Math.max(...fieldsData.map(arr => arr.length));
            const wsData = [];

            for (let r = 0; r < maxRows; r++) {
                const rawDateLine = fieldsData[0][r] || "";
                const parsedDate = parseFrenchDateToDDMMYYYY(rawDateLine);

                wsData[r] = [
                    fieldsData[1][r] || "",              
                    fieldsData[4][r] || "",              
                    parsedDate.full || "",               
                    parsedDate.short || "",              
                    fieldsData[5][r] || "",              
                    fieldsData[6][r] || "",              
                    fieldsData[7][r] || "",
                    parsedDate.short || "",              
                    getValidLocationFromAddress(fieldsData[6][r]), 
                    fieldsData[3][r] || "",              
                    fieldsData[2][r] || "",              
                    "", "", "",                          
                    parsedDate.short || ""               
                ];
            }

            const ws = XLSX.utils.aoa_to_sheet(wsData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Extraction");
            XLSX.writeFile(wb, "extraction.xlsx");
        }

        function copyExcelData() {
            const fieldsData = [], numFields = 8;
            for (let i = 0; i < numFields; i++) {
                fieldsData[i] = document.getElementById("field" + i).value.split("\n");
            }

            const maxRows = Math.max(...fieldsData.map(arr => arr.length));
            let text = "";

            for (let r = 0; r < maxRows; r++) {
                const rawDateLine = fieldsData[0][r] || "";
                const parsedDate = parseFrenchDateToDDMMYYYY(rawDateLine);

                const rowData = [
                    fieldsData[1][r] || "",
                    fieldsData[4][r] || "",
                    parsedDate.full || "",
                    parsedDate.short || "",
                    fieldsData[5][r] || "",
                    fieldsData[6][r] || "",
                    fieldsData[7][r] || "",
                    parsedDate.short || "",
                    getValidLocationFromAddress(fieldsData[6][r]),
                    fieldsData[3][r] || "",
                    fieldsData[2][r] || "",
                    "", "", "",
                    parsedDate.short || ""
                ];

                text += rowData.join("\t") + "\n";
            }

            navigator.clipboard.writeText(text).catch(() => {
                alert("حدث خطأ أثناء النسخ إلى الحافظة.");
            });
        }

        function getValidLocationFromAddress(address) {
            const validLocations = ["laayoune", "casablanca", "tetouan"];
            const corrections = {
                "casabalnca": "Casablanca",
                "casa": "Casablanca",
                "casablana": "Casablanca",
                "casablanc": "Casablanca",
                "laayoun": "Laayoune",
                "laayoune": "Laayoune",
                "tétouan": "Tetouan",
                "tetouan": "Tetouan"
            };

            if (!address || address.trim() === "") return "Casablanca";

            const cleanedAddress = address
                .toLowerCase()
                .normalize("NFD")
                .replace(/[\u0300-\u036f]/g, "")
                .replace(/[^a-z\s]/g, " ")
                .replace(/\s+/g, " ")
                .trim();

            const words = cleanedAddress.split(" ");

            for (const loc of validLocations) {
                for (const word of words) {
                    if (word === loc) return capitalizeFirstLetter(loc);
                }
            }

            for (const [wrong, correct] of Object.entries(corrections)) {
                if (cleanedAddress.includes(wrong)) return correct;
            }

            return "Casablanca";
        }

        function capitalizeFirstLetter(string) {
            return string.charAt(0).toUpperCase() + string.slice(1);
        }

        function removeDuplicatesAndAutoCopy() {
            removeDuplicatesBasedOnReseau();
            copyExcelData();
            alert("تم تنظيف البيانات ونسخها بنجاح!");
        }

        function copyField(index) {
            const field = document.getElementById("field" + index);
            field.select();
            document.execCommand("copy");
            window.getSelection().removeAllRanges();
        }
    </script>
</body>
</html>
