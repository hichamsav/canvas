<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8" />
    <title>EXTRACTION CANVAS</title>
    <style>
        body {
            direction: rtl;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 10px;
            padding-top: 100px;
            display: flex;
            gap: 10px;
            height: 100vh;
            font-size: 13px;
            overflow: hidden;
            box-sizing: border-box;
        }

        .container {
            flex: 1;
            max-width: 50%;
            display: flex;
            flex-direction: column;
            border: 1px solid #ccc;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 1px 1px 5px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header-logo {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            text-align: center;
        }

        .header-logo img {
            height: 60px;
            object-fit: contain;
        }

        h1, h2, h3 {
            font-size: 16px;
            margin-top: 0;
            text-align: center;
        }

        input[type="file"],
        input[type="text"],
        textarea {
            width: 100%;
            font-size: 12px;
            padding: 8px;
            margin-bottom: 8px;
            box-sizing: border-box;
            font-family: monospace;
            height: 60px;
            resize: none;
        }

        button {
            padding: 6px 10px;
            font-size: 13px;
            cursor: pointer;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            margin-bottom: 8px;
            transition: background-color 0.3s ease;
        }

        button:hover {
            background-color: #0056b3;
        }

        .copy-button {
            background-color: #28a745;
        }

        .copy-button:hover {
            background-color: #1e7e34;
        }

        .row {
            display: flex;
            gap: 6px;
            margin-bottom: 10px;
        }

        .field-container {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .line-count {
            font-weight: bold;
            font-size: 12px;
            color: #007bff;
            text-align: center;
            margin-bottom: 4px;
        }

        label {
            font-weight: bold;
            font-size: 12px;
            margin-bottom: 4px;
        }

        #keyword,
        label[for="keyword"] {
            display: none;
        }

        /* Ø²Ø± Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„ */
        .bottom-home-btn {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            z-index: 1000;
            text-decoration: none;
        }

        .bottom-home-btn:hover {
            background: #218838;
        }
    </style>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
</head>
<body>
    <div class="header-logo">
        <img src="https://www.vernegroup.com/wp-content/uploads/2021/08/Image-1-1-1.png" alt="Ø§Ù„Ø´Ø¹Ø§Ø±" />
    </div>
    
    <div class="container" style="max-width: 45%;">
        <h1 style="text-align: center;">ğŸ“ EXTRACTION CANVAS ğŸ“</h1>
        <input type="file" id="folderInput" webkitdirectory directory multiple accept=".txt,.html" />
        <button onclick="mergeFolderTxt()">Ø¯Ù…Ø¬ Ø§Ù„Ù…Ù„ÙØ§Øª</button>

        <textarea id="filteredOutput" rows="10" style="display:none;"></textarea>

        <h3>ğŸ” Ø§Ø³ØªØ®Ø±Ø§Ø¬ ÙƒÙ„Ù…Ø§Øª Ù…ØªØ¹Ø¯Ø¯Ø© (Ù…ÙØµÙˆÙ„Ø© Ø¨ÙØ§ØµÙ„Ø©)</h3>
        <input type="text" id="singleKeywordInput" value="ReÃ§u le,EnvoyÃ©,Sent,Date,ID CASE,Client :,TÃ©lÃ©phone,AccÃ¨s rÃ©seau,ActivitÃ©s de service,Commentaire,Adresse Installation" />
        <label><input type="checkbox" id="startOnlySingleCheckbox" checked /> Ø§Ø³ØªØ®Ø±Ø§Ø¬ ÙÙ‚Ø· Ø§Ù„Ø£Ø³Ø·Ø± Ø§Ù„ØªÙŠ <strong>ØªØ¨Ø¯Ø£</strong> Ø¨Ø§Ù„ÙƒÙ„Ù…Ø§Øª</label><br />
        <button onclick="extractSingleKeyword()">ğŸ” Ø§Ø³ØªØ®Ø±Ø§Ø¬</button>
        <textarea id="singleKeywordOutput" rows="7" readonly placeholder="Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ Ø§Ù„Ø£Ø³Ø·Ø± Ø§Ù„ØªÙŠ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©"></textarea>
        <button onclick="copySingleKeyword()" class="copy-button">ğŸ“‹ Ù†Ø³Ø® Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬</button>
    </div>

    <div class="container" style="max-width: 50%;">
        <div class="row">
            <div class="field-container">
                <div class="line-count" id="count0">0 Ø³Ø·Ø±</div>
                <textarea id="field0" readonly></textarea>
                <button class="copy-button" onclick="copyField(0)">ğŸ“‹ Ù†Ø³Ø® EnvoyÃ©</button>
            </div>
            <div class="field-container">
                <div class="line-count" id="count1">0 Ø³Ø·Ø±</div>
                <textarea id="field1" readonly></textarea>
                <button class="copy-button" onclick="copyField(1)">ğŸ“‹ Ù†Ø³Ø® ID CASE</button>
            </div>
            <div class="field-container">
                <div class="line-count" id="count2">0 Ø³Ø·Ø±</div>
                <textarea id="field2" readonly></textarea>
                <button class="copy-button" onclick="copyField(2)">ğŸ“‹ Ù†Ø³Ø® Client</button>
            </div>
        </div>

        <div class="row">
            <div class="field-container">
                <div class="line-count" id="count3">0 Ø³Ø·Ø±</div>
                <textarea id="field3" readonly></textarea>
                <button class="copy-button" onclick="copyField(3)">ğŸ“‹ Ù†Ø³Ø® TÃ©lÃ©phone</button>
            </div>
            <div class="field-container">
                <div class="line-count" id="count4">0 Ø³Ø·Ø±</div>
                <textarea id="field4" readonly></textarea>
                <button class="copy-button" onclick="copyField(4)">ğŸ“‹ Ù†Ø³Ø® AccÃ¨s rÃ©seau</button>
            </div>
            <div class="field-container">
                <div class="line-count" id="count5">0 Ø³Ø·Ø±</div>
                <textarea id="field5" readonly></textarea>
                <button class="copy-button" onclick="copyField(5)">ğŸ“‹ Ù†Ø³Ø® ActivitÃ©s de service</button>
            </div>
        </div>

        <div class="row">
            <div class="field-container">
                <div class="line-count" id="count6">0 Ø³Ø·Ø±</div>
                <textarea id="field6" readonly></textarea>
                <button class="copy-button" onclick="copyField(6)">ğŸ“‹ Ù†Ø³Ø® Adresse Installation</button>
            </div>
            <div class="field-container">
                <div class="line-count" id="count7">0 Ø³Ø·Ø±</div>
                <textarea id="field7" readonly></textarea>
                <button class="copy-button" onclick="copyField(7)">ğŸ“‹ Ù†Ø³Ø® Commentaire</button>
            </div>
        </div>

        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px;">
            <button onclick="removeDuplicatesBasedOnReseauSmart(); copyExcelData();" style="background-color:#dc3545; color:white;">ğŸ§¹ Remove & Copy ALL ğŸ§¹ </button>
            <button onclick="exportToExcel()" style="background-color:#ff6600; color:white;">â¬‡ï¸ ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ Excel</button>
            <span id="countdown" style="font-weight: bold; color: red; font-size: 14px; margin-right: 10px;"></span>
        </div>
    </div>

    <!-- Ø²Ø± Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„ -->
    <button class="bottom-home-btn" onclick="goToHome()">ğŸ  Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>

    <script>
        // ========== Ø§Ù„Ø­Ù…Ø§ÙŠØ§Øª ÙÙ‚Ø· ==========
        
        // Ø¯Ø§Ù„Ø© Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
        function goToHome() {
            window.location.href = 'index.html';
        }

        // Ù…Ù†Ø¹ Ø§Ù„Ù†Ù‚Ø± Ø§Ù„Ø£ÙŠÙ…Ù†
        document.addEventListener('contextmenu', function(e) {
            e.preventDefault();
            return false;
        });

        // Ù…Ù†Ø¹ ÙØªØ­ Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø·ÙˆØ±ÙŠÙ†
        document.addEventListener('keydown', function(e) {
            if (e.key === 'F12' || 
                (e.ctrlKey && e.shiftKey && e.key === 'I') ||
                (e.ctrlKey && e.shiftKey && e.key === 'J') ||
                (e.ctrlKey && e.shiftKey && e.key === 'C') ||
                (e.ctrlKey && e.key === 'u')) {
                e.preventDefault();
                return false;
            }
        });

        // ========== Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø­Ù…Ø§ÙŠØ§Øª ==========

        // ========== Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø£ØµÙ„ÙŠ Ø¨Ø¯ÙˆÙ† Ø£ÙŠ ØªØºÙŠÙŠØ± ==========
        window.alert = function() {};
        const originalAlert = window.alert;

        window.alert = function(message) {
            if (typeof message === 'string' && message.includes('hichamsav.github.io')) {
                return;
            }
            originalAlert(message);
        };

        document.addEventListener("contextmenu", e => e.preventDefault());
        document.addEventListener("keydown", e => {
            if (e.key === "F12" || (e.ctrlKey && ["u", "s"].includes(e.key.toLowerCase())) || (e.ctrlKey && e.shiftKey && ["I", "J"].includes(e.key))) { 
                e.preventDefault(); 
                return false; 
            }
        });

        let originalMergedContent = "";

        function mergeFolderTxt() {
            const files = Array.from(document.getElementById("folderInput").files).filter(f => f.name.toLowerCase().endsWith(".txt"));
            if (!files.length) {
                alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø¬Ù„Ø¯ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù…Ù„ÙØ§Øª .txt.");
                return;
            }

            files.sort((a, b) => a.name.localeCompare(b.name));
            let merged = "";
            let processed = 0;

            files.forEach(f => {
                const reader = new FileReader();
                reader.onload = e => {
                    merged += `\n===== ${f.name} =====\n` + e.target.result + "\n";
                    processed++;
                    if (processed === files.length) {
                        originalMergedContent = merged;
                        document.getElementById("filteredOutput").value = merged;
                        extractSingleKeyword();
                    }
                };
                reader.readAsText(f);
            });
        }

        function extractSingleKeyword() {
            const lines = document.getElementById("filteredOutput").value.split("\n");
            const extracted = [];
            
            let inTargetBlock = false;
            let currentBlock = [];
            let blocksFound = 0;

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                
                // Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ÙƒØªÙ„Ø© Ø¹Ù†Ø¯Ù…Ø§ Ù†Ø¬Ø¯ "Date:"
                if (line.startsWith("Date:")) {
                    if (currentBlock.length > 0) {
                        extracted.push(...currentBlock);
                        extracted.push(""); // ÙØ§ØµÙ„ Ø¨ÙŠÙ† Ø§Ù„ÙƒØªÙ„
                        blocksFound++;
                    }
                    currentBlock = [line];
                    inTargetBlock = true;
                    continue;
                }
                
                // Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ÙƒØªÙ„Ø© Ø¹Ù†Ø¯Ù…Ø§ Ù†Ø¬Ø¯ "Adresse Installation"
                if (inTargetBlock && line.includes("Adresse Installation :")) {
                    currentBlock.push(line);
                    extracted.push(...currentBlock);
                    extracted.push(""); // ÙØ§ØµÙ„ Ø¨ÙŠÙ† Ø§Ù„ÙƒØªÙ„
                    blocksFound++;
                    currentBlock = [];
                    inTargetBlock = false;
                    continue;
                }
                
                // Ø¥Ø°Ø§ ÙƒÙ†Ø§ Ø¯Ø§Ø®Ù„ Ø§Ù„ÙƒØªÙ„Ø© Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ©ØŒ Ù†Ø¶ÙŠÙ Ø§Ù„Ø³Ø·Ø±
                if (inTargetBlock && line) {
                    currentBlock.push(line);
                }
            }
            
            // Ø¥Ø¶Ø§ÙØ© Ø¢Ø®Ø± ÙƒØªÙ„Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª ØºÙŠØ± Ù…ÙƒØªÙ…Ù„Ø©
            if (currentBlock.length > 0) {
                extracted.push(...currentBlock);
                blocksFound++;
            }

            document.getElementById("singleKeywordOutput").value = extracted.join("\n");
            console.log("ØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ " + blocksFound + " ÙƒØªÙ„Ø© Ø¨ÙŠØ§Ù†Ø§Øª");
            filterAndDistribute();
        }

        function copySingleKeyword() { 
            const t = document.getElementById("singleKeywordOutput"); 
            t.select(); 
            document.execCommand("copy"); 
            window.getSelection().removeAllRanges(); 
        }

        function decodeCorruptedCharacters(text) {
            return text
                .replace(/ï¿½/g, "Ã©")
                .replace(/ÃƒÂ©/g, "Ã©")
                .replace(/ÃƒÂ¨/g, "Ã¨")
                .replace(/Ãƒ/g, "Ã ")
                .replace(/ÃƒÂ´/g, "Ã´")
                .replace(/ÃƒÂª/g, "Ãª")
                .replace(/ÃƒÂ¢/g, "Ã¢")
                .replace(/ÃƒÂ¼/g, "Ã¼")
                .replace(/ÃƒÂ§/g, "Ã§")
                .replace(/Ã‚/g, "");
        }

        function normalizePhone(phone) {
            return phone.startsWith("0") ? phone.substring(1) : phone;
        }

        function extractDateFromSent(sentLine) {
            // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ØªØ§Ø±ÙŠØ® Ù…Ù† Ø³Ø·Ø± Date: 09/26/2025 18:13:01
            const match = sentLine.match(/Date:\s*(\d{2}\/\d{2}\/\d{4})/);
            return match ? match[1] : "";
        }

        function filterAndDistribute() {
            const text = document.getElementById('singleKeywordOutput').value.split("\n");
            const fields = Array.from({ length: 8 }, () => []);
            let current = {};
            let currentAdresse = "";
            let currentVille = "";
            let currentDate = "";
            let commentaireContent = "";
            
            for (let i = 0; i < text.length; i++) {
                const line = text[i].trim();
                
                if (!line) continue;
                
                // â¬‡ï¸ Ø¨Ø¯Ø§ÙŠØ© Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© - Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„ Ø´ÙŠØ¡
                if (line.match(/^Date:/i)) {
                    // Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø³Ø§Ø¨Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
                    if (Object.keys(current).length > 0) {
                        for (let j = 0; j <= 7; j++) {
                            fields[j].push(current[j] || "");
                        }
                    }
                    
                    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ù„Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©
                    current = {};
                    currentDate = extractDateFromSent(line);
                    current[0] = line.replace(/^Date:\s*/i, "").trim();
                    currentAdresse = "";
                    currentVille = "";
                    commentaireContent = "";
                }
                else if (line.match(/^ID CASE\s*:/i)) {
                    current[1] = line.replace(/^ID CASE\s*:\s*/i, "").trim();
                }
                else if (line.match(/^Client\s*:/i)) {
                    current[2] = line.replace(/^Client\s*:\s*/i, "").trim();
                }
                else if (line.match(/^TÃ©lÃ©phone\s*:/i) || line.match(/^Tï¿½lï¿½phone\s*:/i)) {
                    let phoneValue = line.replace(/^TÃ©lÃ©phone\s*:\s*/i, "").replace(/^Tï¿½lï¿½phone\s*:\s*/i, "").trim();
                    current[3] = normalizePhone(phoneValue);
                }
                else if (line.match(/^AccÃ¨s rÃ©seau\s*:/i) || line.match(/^Accï¿½s rï¿½seau\s*:/i)) {
                    let reseauValue = line.replace(/^AccÃ¨s rÃ©seau\s*:\s*/i, "").replace(/^Accï¿½s rï¿½seau\s*:\s*/i, "").trim();
                    current[4] = normalizePhone(reseauValue);
                }
                else if (line.match(/^ActivitÃ©s de service\s*:/i) || line.match(/^Activitï¿½s de service\s*:/i)) {
                    let rawValue = line.replace(/^ActivitÃ©s de service\s*:\s*/i, "").replace(/^Activitï¿½s de service\s*:\s*/i, "").trim();
                    let parts = rawValue.split("|");
                    let lastPart = parts.length > 1 ? parts[parts.length - 1].trim() : rawValue.trim();
                    current[5] = lastPart.replace(/[^\w\s\u00C0-\u017F]/g, '').trim();
                }
                else if (line.match(/^Commentaire\s*:/i)) {
                    // â¬‡ï¸ Commentaire Ù„Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙÙ‚Ø·
                    commentaireContent = line.replace(/^Commentaire\s*:\s*/i, "").trim();
                    current[7] = commentaireContent;
                    
                    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Adresse
                    if (commentaireContent.includes("Adresse :") || commentaireContent.includes("adresse :")) {
                        let adresseMatch = commentaireContent.match(/Adresse\s*:\s*(.+)/i) || commentaireContent.match(/adresse\s*:\s*(.+)/i);
                        if (adresseMatch) {
                            currentAdresse = adresseMatch[1].trim();
                        }
                    }
                }
                // â¬‡ï¸ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Adresse ÙÙŠ Ø£ÙŠ Ø³Ø·Ø±
                else if (line.includes("Adresse :") || line.includes("adresse :")) {
                    let adresseMatch = line.match(/Adresse\s*:\s*(.+)/i) || line.match(/adresse\s*:\s*(.+)/i);
                    if (adresseMatch) {
                        currentAdresse = adresseMatch[1].trim();
                    }
                }
                else if (line.match(/^Adresse Installation\s*:/i)) {
                    let adresseValue = line.replace(/^Adresse Installation\s*:\s*/i, "").trim();
                    
                    // â¬‡ï¸ Ø¥Ø°Ø§ ÙƒØ§Ù† Adresse Installation ÙØ§Ø±ØºØ§Ù‹
                    if (!adresseValue || adresseValue === "") {
                        if (currentAdresse) {
                            adresseValue = currentAdresse;
                        } else if (currentVille) {
                            adresseValue = currentVille;
                        }
                    }
                    
                    current[6] = adresseValue || "";
                    current.date = currentDate;
                    current[7] = commentaireContent; // â¬‡ï¸ ØªØ£ÙƒÙŠØ¯ Ø­ÙØ¸ Commentaire Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙ‚Ø·
                    
                    // Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„
                    for (let j = 0; j <= 7; j++) {
                        fields[j].push(current[j] || "");
                    }
                    
                    // â¬‡ï¸ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ù„Ù„Ù…Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©
                    current = {};
                    currentAdresse = "";
                    currentVille = "";
                    currentDate = "";
                    commentaireContent = "";
                }
            }

            // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£ÙŠ Ø³Ø¬Ù„ Ù…ØªØ¨Ù‚ÙŠ
            if (Object.keys(current).length > 0) {
                for (let j = 0; j <= 7; j++) {
                    fields[j].push(current[j] || "");
                }
            }

            for (let i = 0; i <= 7; i++) {
                let fieldValue = fields[i].join("\n");
                fieldValue = decodeCorruptedCharacters(fieldValue);
                document.getElementById("field" + i).value = fieldValue;
                document.getElementById("count" + i).textContent = fields[i].length + " Ø³Ø·Ø±";
            }
        }

        function removeDuplicatesBasedOnReseauSmart() {
            const numFields = 8;
            const fieldsData = [];
            for (let i = 0; i < numFields; i++) {
                fieldsData[i] = document.getElementById("field" + i).value.split("\n");
            }

            const grouped = new Map();
            const maxRows = Math.max(...fieldsData.map(arr => arr.length));

            for (let r = 0; r < maxRows; r++) {
                const reseau = fieldsData[4][r] || "";
                const record = [];

                for (let c = 0; c < numFields; c++) {
                    record.push(fieldsData[c][r] || "");
                }

                if (!reseau) continue;

                if (!grouped.has(reseau)) {
                    grouped.set(reseau, []);
                }

                grouped.get(reseau).push(record);
            }

            const selectedRecords = [];

            for (const [reseau, records] of grouped.entries()) {
                // Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø£ÙƒØ«Ø± Ø§ÙƒØªÙ…Ø§Ù„Ø§Ù‹ (Ø§Ù„Ø°ÙŠ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Commentaire Ø£Ùˆ Adresse Installation)
                let best = records[0];

                for (const rec of records) {
                    const hasComment = rec[7] && rec[7].trim().length > 0;
                    const hasAdresse = rec[6] && rec[6].trim().length > 0;

                    const bestHasComment = best[7] && best[7].trim().length > 0;
                    const bestHasAdresse = best[6] && best[6].trim().length > 0;

                    if ((hasComment && !bestHasComment) || (hasAdresse && !bestHasAdresse)) {
                        best = rec;
                    }
                }

                // ØªØ¹ÙˆÙŠØ¶ Adresse Installation Ø¥Ø°Ø§ ÙƒØ§Ù†Øª ÙØ§Ø±ØºØ©
                if (!best[6] || best[6].trim() === "") {
                    const commentaire = best[7] || "";
                    const adresseMatch = commentaire.match(/Adresse\s*:\s*(.+)/i);
                    const villeMatch = commentaire.match(/Ville\s*:\s*(.+)/i);

                    if (adresseMatch) best[6] = adresseMatch[1].trim();
                    else if (villeMatch) best[6] = villeMatch[1].trim();
                }

                selectedRecords.push(best);
            }

            // ØªÙØ±ÙŠØº Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© ÙÙŠ Ø§Ù„Ø­Ù‚ÙˆÙ„
            for (let i = 0; i < numFields; i++) {
                const columnData = selectedRecords.map(rec => decodeCorruptedCharacters(rec[i] || ""));
                document.getElementById("field" + i).value = columnData.join("\n");
                document.getElementById("count" + i).textContent = columnData.length + " Ø³Ø·Ø±";
            }
        }

        function parseFrenchDateToDDMMYYYY(str) {
            const months = {
                janvier: "01", fÃ©vrier: "02", fevrier: "02", mars: "03", avril: "04", mai: "05",
                juin: "06", juillet: "07", aoÃ»t: "08", aout: "08", septembre: "09",
                octobre: "10", novembre: "11", dÃ©cembre: "12", decembre: "12"
            };

            const regex = /(\d{1,2})\s+([a-zÃ©Ã»]+)\s+(\d{4})(?:\s+(\d{1,2}):(\d{2})(?::(\d{2}))?)?/i;
            const match = str.match(regex);

            if (match) {
                const day = match[1].padStart(2, "0");
                const month = months[match[2].toLowerCase()] || "01";
                const year = match[3];
                const hour = match[4] ? match[4].padStart(2, "0") : "00";
                const minute = match[5] ? match[5].padStart(2, "0") : "00";
                const second = match[6] ? match[6].padStart(2, "0") : "00";

                return {
                    full: `${day}/${month}/${year} ${hour}:${minute}:${second}`,
                    short: `${day}/${month}/${year}`
                };
            }

            const parsed = new Date(str);
            if (!isNaN(parsed)) {
                const day = String(parsed.getDate()).padStart(2, "0");
                const month = String(parsed.getMonth() + 1).padStart(2, "0");
                const year = parsed.getFullYear();
                const hour = String(parsed.getHours()).padStart(2, "0");
                const minute = String(parsed.getMinutes()).padStart(2, "0");
                const second = String(parsed.getSeconds()).padStart(2, "0");

                return {
                    full: `${day}/${month}/${year} ${hour}:${minute}:${second}`,
                    short: `${day}/${month}/${year}`
                };
            }

            return { full: "", short: "" };
        }

        function exportToExcel() {
            const fieldsData = [], numFields = 8;
            for (let i = 0; i < numFields; i++) {
                fieldsData[i] = document.getElementById("field" + i).value.split("\n");
            }

            const maxRows = Math.max(...fieldsData.map(arr => arr.length));
            const wsData = [];

            for (let r = 0; r < maxRows; r++) {
                const rawDateLine = fieldsData[0][r] || "";
                const parsedDate = parseFrenchDateToDDMMYYYY(rawDateLine);

                wsData[r] = [
                    fieldsData[1][r] || "",              
                    fieldsData[4][r] || "",              
                    parsedDate.full || "",               
                    parsedDate.short || "",              
                    fieldsData[5][r] || "",              
                    fieldsData[6][r] || "",              
                    fieldsData[7][r] || "",
                    parsedDate.short || "",              
                    getValidLocationFromAddress(fieldsData[6][r]), 
                    fieldsData[3][r] || "",              
                    fieldsData[2][r] || "",              
                    "", "", "",                          
                    parsedDate.short || ""               
                ];
            }

            const ws = XLSX.utils.aoa_to_sheet(wsData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Extraction");
            XLSX.writeFile(wb, "extraction.xlsx");
        }

        function copyExcelData() {
            const fieldsData = [], numFields = 8;
            for (let i = 0; i < numFields; i++) {
                fieldsData[i] = document.getElementById("field" + i).value.split("\n");
            }

            const maxRows = Math.max(...fieldsData.map(arr => arr.length));
            let text = "";

            for (let r = 0; r < maxRows; r++) {
                const rawDateLine = fieldsData[0][r] || "";
                const parsedDate = parseFrenchDateToDDMMYYYY(rawDateLine);

                const rowData = [
                    fieldsData[1][r] || "",
                    fieldsData[4][r] || "",
                    parsedDate.full || "",
                    parsedDate.short || "",
                    fieldsData[5][r] || "",
                    fieldsData[6][r] || "",
                    fieldsData[7][r] || "",
                    parsedDate.short || "",
                    getValidLocationFromAddress(fieldsData[6][r]),
                    fieldsData[3][r] || "",
                    fieldsData[2][r] || "",
                    "", "", "",
                    parsedDate.short || ""
                ];

                text += rowData.join("\t") + "\n";
            }

            navigator.clipboard.writeText(text).catch(() => {
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù†Ø³Ø® Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©.");
            });
        }

        function getValidLocationFromAddress(address) {
            const validLocations = ["laayoune", "casablanca", "tetouan"];
            const corrections = {
                "casabalnca": "Casablanca",
                "casa": "Casablanca",
                "casablana": "Casablanca",
                "casablanc": "Casablanca",
                "laayoun": "Laayoune",
                "laayoune": "Laayoune",
                "tÃ©touan": "Tetouan",
                "tetouan": "Tetouan"
            };

            if (!address || address.trim() === "") return "Casablanca";

            const cleanedAddress = address
                .toLowerCase()
                .normalize("NFD")
                .replace(/[\u0300-\u036f]/g, "")
                .replace(/[^a-z\s]/g, " ")
                .replace(/\s+/g, " ")
                .trim();

            const words = cleanedAddress.split(" ");

            for (const loc of validLocations) {
                for (const word of words) {
                    if (word === loc) return capitalizeFirstLetter(loc);
                }
            }

            for (const [wrong, correct] of Object.entries(corrections)) {
                if (cleanedAddress.includes(wrong)) return correct;
            }

            return "Casablanca";
        }

        function capitalizeFirstLetter(string) {
            return string.charAt(0).toUpperCase() + string.slice(1);
        }

        function removeDuplicatesAndAutoCopy() {
            removeDuplicatesBasedOnReseau();
            copyExcelData();
            alert("ØªÙ… ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆÙ†Ø³Ø®Ù‡Ø§ Ø¨Ù†Ø¬Ø§Ø­!");
        }

        function copyField(index) {
            const field = document.getElementById("field" + index);
            field.select();
            document.execCommand("copy");
            window.getSelection().removeAllRanges();
        }
    </script>
</body>
</html>
